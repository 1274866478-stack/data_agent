# 前端错误流程详细分析

## 问题描述
前端显示错误："查询失败: unhandled errors in a TaskGroup (1 sub-exception)"

## 完整流程追踪

### 第一步：用户发送消息
**位置**: `frontend/src/app/(app)/ai-assistant/page.tsx`
- 用户在输入框输入："帮我统计一下2023年电子产品的销售额是多少"
- 点击发送或按 Enter

### 第二步：前端调用 sendMessage
**位置**: `frontend/src/store/chatStore.ts:271`
```typescript
sendMessage: async (content: string, dataSourceId?: string) => {
  // ... 处理逻辑
  await state._sendOnlineMessage(content, state.currentSession.id, dataSourceId)
}
```

### 第三步：判断是否使用 Agent
**位置**: `frontend/src/store/chatStore.ts:357`
```typescript
const useAgent = isAgentQuery(content)  // 返回 true（因为包含"统计"关键词）
```

### 第四步：调用 Agent API
**位置**: `frontend/src/store/chatStore.ts:363`
```typescript
const agentResponse = await queryAgent({
  query: content,
  session_id: sessionId,
  generate_chart: true,
  tenant_id: 'default_tenant',
})
```

### 第五步：发送 HTTP 请求
**位置**: `frontend/src/services/agentService.ts:78-92`
```typescript
export async function queryAgent(request: AgentQueryRequest): Promise<AgentQueryResponse> {
  const response = await fetch(`${API_BASE_URL}/agent/query`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(request),
  });
  
  if (!response.ok) {
    throw new Error(`Agent query failed: ${response.status} - ${errorText}`);
  }
  
  return response.json();  // ⚠️ 这里返回的 JSON 包含 success: false, error: "..."
}
```

### 第六步：后端接收请求
**位置**: `backend/src/app/api/v1/endpoints/agent.py:88`
```python
@router.post("/agent/query", response_model=AgentQueryResponse)
async def query_agent(request: AgentQueryRequest, db: Session = Depends(get_db)):
    # ...
    result = await run_agent_for_api(request=agent_request, database_url=database_url)
    return AgentQueryResponse(**result)  # 返回给前端
```

### 第七步：后端执行 Agent
**位置**: `backend/src/app/services/agent/agent_service.py:840`
```python
result = await run_agent(
    question=request.query,
    database_url=db_url,
    thread_id=request.session_id or "default",
    enable_echarts=request.generate_chart,
)
```

### 第八步：Agent 流执行（问题发生点）
**位置**: `backend/src/app/services/agent/agent_service.py:647`
```python
async for step in agent.astream(
    {"messages": [HumanMessage(content=question)]},
    config,
    stream_mode="updates",
):
    # ... 处理步骤
```

**问题发生**：在 `agent.astream()` 执行过程中，某个工具（可能是数据库查询工具或 MCP 工具）执行失败，抛出了 `TaskGroup` 异常。

### 第九步：捕获异常
**位置**: `backend/src/app/services/agent/agent_service.py:682`
```python
except BaseException as stream_error:
    # 捕获 TaskGroup 异常
    error_msg = str(stream_error)  # "unhandled errors in a TaskGroup (1 sub-exception)"
    
    # 尝试提取详细错误信息
    if "TaskGroup" in error_msg or "sub-exception" in error_msg:
        if hasattr(stream_error, "__cause__") and stream_error.__cause__:
            error_msg = f"Agent执行失败: {str(stream_error.__cause__)}"
        # ...
    
    raise Exception(error_msg) from stream_error
```

**问题**：如果 `__cause__` 或 `__context__` 不存在或为空，错误信息仍然是原始的 "unhandled errors in a TaskGroup (1 sub-exception)"。

### 第十步：外层异常处理
**位置**: `backend/src/app/services/agent/agent_service.py:739`
```python
except Exception as e:
    logger.error(f"Agent execution failed: {e}", exc_info=True)
    error_response = VisualizationResponse(
        success=False,
        error=str(e),  # ⚠️ 这里就是 "unhandled errors in a TaskGroup (1 sub-exception)"
    )
    return {
        "success": False,
        "error": str(e),
        # ...
    }
```

### 第十一步：格式化错误响应
**位置**: `backend/src/app/services/agent/agent_service.py:867`
```python
else:
    return format_error_response(result.get("error", "Unknown error"), result.get("sql", ""))
```

**位置**: `backend/src/app/services/agent/response_formatter.py:139`
```python
def format_error_response(error: str, sql: str = "") -> Dict[str, Any]:
    return {
        "success": False,
        "answer": "",
        "sql": sql or "",
        "table": {...},
        "chart": None,
        "echarts_option": None,
        "error": error  # ⚠️ 错误信息传递到这里
    }
```

### 第十二步：返回给前端
**位置**: `backend/src/app/api/v1/endpoints/agent.py:155`
```python
return AgentQueryResponse(**result)  # 包含 success=False, error="unhandled errors..."
```

### 第十三步：前端接收响应
**位置**: `frontend/src/services/agentService.ts:92`
```typescript
return response.json();  // 返回 { success: false, error: "unhandled errors..." }
```

### 第十四步：前端处理错误
**位置**: `frontend/src/store/chatStore.ts:376-378`
```typescript
if (!agentResponse.success) {
  answerContent = `查询失败: ${agentResponse.error || '未知错误'}`
  // ⚠️ 这里显示 "查询失败: unhandled errors in a TaskGroup (1 sub-exception)"
}
```

### 第十五步：显示错误消息
**位置**: `frontend/src/store/chatStore.ts:381-389`
```typescript
const assistantMessage: Omit<ChatMessage, 'id'> = {
  role: 'assistant',
  content: answerContent,  // "查询失败: unhandled errors..."
  timestamp: new Date(),
  status: 'sent',
  agentResponse: agentResponse,
}
state.addMessage(assistantMessage)  // 添加到聊天记录并显示
```

## 问题根源

1. **TaskGroup 异常提取不完整**：在 `agent_service.py:682-701` 中，虽然尝试提取 `__cause__` 和 `__context__`，但如果这些属性不存在或为空，就会使用原始的异常字符串。

2. **异常信息不够详细**：`TaskGroup` 异常通常包含子异常，但当前的代码没有完全提取所有子异常的信息。

3. **工具执行失败未捕获**：在工具执行层面（`MCPClientWrapper`），虽然添加了异常处理，但可能某些异常仍然被 `TaskGroup` 包装后抛出。

## 解决方案

已改进 `agent_service.py:682-701` 的异常处理代码，现在会：
1. 更全面地提取 `ExceptionGroup` 的所有子异常
2. 检查 `__cause__` 是否也是 `ExceptionGroup`，如果是则递归提取
3. 检查 `__context__` 和 `args` 属性
4. 如果无法提取详细信息，记录完整异常到日志，并返回更友好的错误消息

## 下一步

1. 重启后端服务使更改生效
2. 再次测试查询
3. 如果仍有问题，查看后端日志获取更详细的错误信息


