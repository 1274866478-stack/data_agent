# 数据源选择问题诊断指南

## 问题描述

用户反馈：前端测试看起来不错，但是内容跟连接的Excel数据库不一样。

## 可能的原因

### 1. 数据源选择不一致
- **前端显示的数据源**：用户在下拉菜单中看到的数据源名称
- **后端实际使用的数据源**：可能因为自动选择逻辑使用了不同的数据源

### 2. 自动选择逻辑问题
当用户没有明确选择数据源时：
- **前端**：自动使用第一个活跃数据源（按加载顺序）
- **后端**：如果没有 `connection_id`，也自动使用第一个活跃数据源（按数据库查询顺序）

如果前端和后端获取数据源的顺序不一致，就会导致使用不同的数据源。

### 3. 数据源列表顺序问题
- 数据源列表的排序可能不一致（按创建时间、ID、名称等）
- 前端和后端可能使用不同的排序规则

## 诊断步骤

### 步骤1：查看浏览器控制台日志

打开浏览器开发者工具（F12），查看 Console 标签页，查找以下日志：

```
🔍 [数据源诊断] 前端发送请求时的数据源信息:
  - 用户选择的数据源IDs: [...]
  - 最终使用的 connection_id: ...
  - context.data_sources: [...]
  - 选中的数据源详情:
    [1] ID: ..., 名称: ..., 类型: ..., 状态: ...
```

### 步骤2：查看后端日志

查看后端日志文件（`backend/logs/app.log`），查找以下日志：

```
🔍 [数据源诊断] 租户 ... 共有 ... 个活跃数据源:
  [1] ID: ..., 名称: ..., 类型: ..., 状态: ...
  [2] ID: ..., 名称: ..., 类型: ..., 状态: ...
...
⚠️ [数据源诊断] 未指定数据源，自动使用第一个活跃数据源: ID=..., 名称=..., 类型=...
🎯 [数据源诊断] 最终使用的数据源: ID=..., 名称=..., 类型=...
```

### 步骤3：对比前端和后端的数据源

1. **前端显示的数据源**：在AI助手页面的下拉菜单中查看
2. **后端使用的数据源**：在日志中查看 `🎯 [数据源诊断] 最终使用的数据源`
3. **对比**：检查ID和名称是否一致

## 解决方案

### 方案1：明确选择数据源（推荐）

**操作步骤**：
1. 在AI助手页面，点击数据源下拉菜单
2. **明确选择**你要使用的Excel数据源（不要选择"所有数据源（自动）"）
3. 确保下拉菜单中显示的是你期望的数据源名称
4. 重新发送查询

### 方案2：检查数据源列表

**操作步骤**：
1. 进入"数据源管理"页面
2. 查看所有活跃的数据源
3. 确认你期望使用的Excel数据源是否存在且状态为"活跃"
4. 如果有多个数据源，注意它们的顺序

### 方案3：重新上传数据源

如果数据源选择仍然有问题：

1. **备份当前数据**（如果需要）
2. **删除旧的数据源**
3. **重新上传Excel文件**，创建新的数据源
4. **在AI助手中明确选择新创建的数据源**

## 预防措施

### 1. 始终明确选择数据源
- 不要依赖"所有数据源（自动）"选项
- 在发送查询前，确认下拉菜单显示的是正确的数据源名称

### 2. 使用有意义的数据源名称
- 上传Excel文件时，使用描述性的名称（例如："2024年销售数据"而不是"test_data"）
- 这样更容易在列表中识别正确的数据源

### 3. 定期检查数据源状态
- 定期查看"数据源管理"页面
- 确保使用的数据源状态为"活跃"
- 删除不再使用的旧数据源

## 技术细节

### 数据源选择逻辑

**前端逻辑**（`frontend/src/store/chatStore.ts`）：
```typescript
// 如果没有选择数据源，自动使用第一个活跃数据源
if (dataSourceIds.length === 0 && activeDataSources.length > 0) {
  dataSourceIds = [activeDataSources[0].id]
}
```

**后端逻辑**（`backend/src/app/api/v1/endpoints/query.py`）：
```python
# 如果没有指定数据源，自动使用第一个活跃数据源
if not data_source_id:
    active_sources = await data_source_service.get_data_sources(
        tenant_id=tenant.id,
        db=db,
        active_only=True,
        limit=1
    )
    if active_sources:
        selected_source = active_sources[0]
```

### 数据源排序

数据源的顺序取决于：
- 数据库查询的默认排序（通常是按ID或创建时间）
- 前端加载数据源的顺序

**建议**：不要依赖自动选择，始终明确指定要使用的数据源。

## 常见问题

### Q1: 为什么前端显示的数据源和实际查询的数据源不一样？

**A**: 可能是因为：
1. 前端和后端获取数据源的顺序不一致
2. 数据源列表在查询时发生了变化
3. 自动选择逻辑选择了错误的数据源

**解决方案**：明确选择数据源，不要使用"所有数据源（自动）"选项。

### Q2: 如何确认当前使用的是哪个数据源？

**A**: 
1. 查看浏览器控制台的诊断日志
2. 查看后端日志文件
3. 在AI助手页面明确选择数据源，确保下拉菜单显示正确的名称

### Q3: 如果数据源选择正确，但查询结果仍然不对怎么办？

**A**: 可能的原因：
1. Excel文件内容已更新，但数据源没有刷新
2. Excel文件有多个Sheet，查询了错误的Sheet
3. 数据源连接字符串指向了错误的文件

**解决方案**：
1. 重新上传Excel文件，创建新的数据源
2. 检查Excel文件是否包含多个Sheet，确认查询的是正确的Sheet
3. 在数据源管理中检查连接字符串是否正确

## 联系支持

如果问题仍然存在，请提供以下信息：
1. 浏览器控制台的诊断日志
2. 后端日志中的诊断信息
3. 数据源管理页面的截图
4. 期望使用的数据源名称和ID
5. 实际查询结果和期望结果的对比

