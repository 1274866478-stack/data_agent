# Data Agent V4 - 第7部分：后端架构

## V4 认证架构

### JWT 验证中间件

deps.py 必须被完全替换。新的依赖项必须：

1. 从 Authorization: Bearer <JWT_TOKEN> 头中解码 JWT
2. 使用 Clerk/Auth0 的公钥验证令牌
3. 提取 tenant_id 和用户信息

```python
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer
import jwt

security = HTTPBearer()

async def get_current_tenant(token: str = Depends(security)):
    try:
        # 验证 JWT 并提取租户信息
        payload = jwt.decode(token.credentials, PUBLIC_KEY, algorithms=["RS256"])
        tenant_id = payload.get("tenant_id")
        if not tenant_id:
            raise HTTPException(status_code=401, detail="Invalid token")
        return tenant_id
    except jwt.PyJWTError:
        raise HTTPException(status_code=401, detail="Invalid token")
```

## V4 租户隔离

### Agentic Core 更新

agent_core.py 必须更新，接受 tenant_id 作为参数：

```python
async def process_query(question: str, tenant_id: str):
    # 所有后续调用都传入 tenant_id
    sql_result = await sql_chain.execute(question, tenant_id)
    rag_result = await rag_chain.execute(question, tenant_id)
    # ...
```

### RAG 链租户隔离

必须在 ChromaDB 检索中添加租户过滤器：

```python
# 检索时添加租户过滤
collection.get(
    query_embeddings=embedding,
    where={"tenant_id": tenant_id}  # 关键：租户隔离
)
```

### RAG-SQL 链租户隔离

必须按租户获取数据库连接：

```python
async def execute_sql_query(question: str, tenant_id: str):
    # 1. 从 PostgreSQL 获取租户的数据库连接
    connection = await get_tenant_database_connection(tenant_id)

    # 2. 使用该连接执行查询
    result = await execute_query(connection, question)
    return result
```

## 安全要求

1. **JWT 验证**: 每个端点都必须验证 JWT
2. **租户隔离**: 所有数据库查询必须包含租户过滤
3. **加密存储**: 数据库连接字符串必须在存储前加密

---
**分片索引**: 07-后端架构.md | **总页数**: 7/17