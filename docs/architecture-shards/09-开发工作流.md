# Data Agent V4 - 第9部分：开发工作流

## Local Development Setup (本地开发设置)

### Initial Setup (初次安装)

```bash
# 1. 克隆仓库
git clone [REPO_URL] && cd Data-Agent-V4/

# 2. 复制 .env 模板
cp backend/.env.example backend/.env
cp frontend/.env.local.example frontend/.env.local

# 3. 填入你的 ZHIPUAI_API_KEY 和 Clerk/Auth0 密钥
# 编辑上述文件，填入相应的 API 密钥

# 4. (V4 升级) 启动整个 SaaS 环境
docker compose up --build
```

## 开发环境要求

### 系统要求
- Docker Desktop (Windows)
- Node.js 18+ (本地开发时)
- Python 3.11+ (本地开发时)

### 开发工具
- IDE: VS Code (推荐)
- 数据库管理: pgAdmin (PostgreSQL)
- 对象存储管理: MinIO Console

## 开发流程

### 1. 功能开发流程
1. 从 `develop` 分支创建功能分支
2. 实现功能代码
3. 编写测试用例
4. 提交代码审查
5. 合并到 `develop` 分支

### 2. 测试流程
```bash
# 后端测试
cd backend
pytest tests/

# 前端测试
cd frontend
npm run test

# 集成测试
docker compose -f docker-compose.test.yml up
```

### 3. 代码质量检查
```bash
# 后端代码格式化
cd backend
black src/
isort src/
flake8 src/

# 前端代码格式化
cd frontend
npm run format
npm run lint
```

## 本地调试

### 后端调试
```bash
# 直接运行后端 (绕过 Docker)
cd backend
python -m uvicorn src.app.main:app --reload --host 0.0.0.0 --port 8000
```

### 前端调试
```bash
# 直接运行前端 (绕过 Docker)
cd frontend
npm run dev
```

### 数据库调试
```bash
# 连接到 PostgreSQL 容器
docker exec -it data-agent-db psql -U postgres -d dataagent
```

## 数据库迁移管理

项目使用Alembic进行数据库版本控制和迁移管理。

### Alembic简介
- ✅ 版本控制数据库schema
- ✅ 自动生成迁移脚本
- ✅ 支持升级和降级
- ✅ 多环境配置

### 迁移文件结构
```
backend/
├── alembic/
│   ├── versions/          # 迁移脚本目录
│   ├── env.py            # Alembic环境配置
│   └── script.py.mako    # 迁移脚本模板
├── alembic.ini           # Alembic配置文件
└── src/app/data/models.py # SQLAlchemy模型定义
```

### 常用迁移命令

#### 查看状态
```bash
cd backend
alembic current          # 查看当前版本
alembic history          # 查看迁移历史
alembic show head        # 查看最新版本
```

#### 创建迁移
```bash
# 自动生成迁移（推荐）
alembic revision --autogenerate -m "add tenant quota fields"

# 手动创建迁移
alembic revision -m "migrate legacy data"
```

#### 应用迁移
```bash
# 升级到最新版本
alembic upgrade head

# 升级到特定版本
alembic upgrade abc123

# 回滚到上一个版本
alembic downgrade -1

# 回滚到特定版本
alembic downgrade abc123
```

### 迁移最佳实践

1. **命名规范**: 使用描述性的迁移消息
   ```bash
   # ✅ 好的命名
   alembic revision --autogenerate -m "add tenant quota fields"

   # ❌ 不好的命名
   alembic revision --autogenerate -m "update"
   ```

2. **审查迁移**: 自动生成后务必检查迁移脚本
   ```bash
   # 生成迁移
   alembic revision --autogenerate -m "add new fields"

   # 查看生成的文件
   cat alembic/versions/xxx_add_new_fields.py

   # 测试迁移
   alembic upgrade head && alembic downgrade -1
   ```

3. **数据与Schema分离**: 复杂迁移分步进行
   ```bash
   # 第一步: Schema变更
   alembic revision --autogenerate -m "add status column"

   # 第二步: 数据迁移
   alembic revision -m "populate status column"
   ```

### 故障排查

#### 迁移冲突
```bash
# 查看所有head
alembic heads

# 合并heads
alembic merge -m "merge heads" head1 head2
```

#### 数据库状态不一致
```bash
# 标记为特定版本(不执行SQL)
alembic stamp head
```

#### 迁移失败
```bash
# 回滚失败的迁移
alembic downgrade -1

# 修复迁移脚本后重新应用
alembic upgrade head
```

## 环境变量管理

### 敏感信息
- 所有 API 密钥不得提交到代码仓库
- 使用 `.env.example` 作为模板
- 在 CI/CD 中使用环境变量管理

### 配置验证
启动时验证所有必需的环境变量：
```python
# backend/src/app/core/config.py
def validate_config():
    required_vars = ["ZHIPUAI_API_KEY", "DB_URL", "CLERK_JWT_PUBLIC_KEY"]
    for var in required_vars:
        if not getattr(settings, var):
            raise ValueError(f"Missing required environment variable: {var}")
```

---
**分片索引**: 09-开发工作流.md | **总页数**: 9/17