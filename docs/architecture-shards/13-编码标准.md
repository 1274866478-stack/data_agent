# Data Agent V4 - 第13部分：编码标准

## Critical Fullstack Rules (关键全栈规则)

### 规则 1: UI 规范
**要求**: 绝不能使用自定义 CSS。必须使用 "the curator." 规范（style.md）

**实施指南**:
```typescript
// ✅ 正确：使用 shadcn/ui 组件
import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"

// ❌ 错误：使用自定义样式
<div style={{ backgroundColor: 'blue', padding: '10px' }}>
  Custom styled content
</div>
```

**组件设计原则**:
- 统一的间距系统 (8px 网格)
- 一致的颜色调色板
- 响应式设计优先
- 可访问性标准 (WCAG 2.1 AA)

### 规则 2: API 调用
**要求**: 前端必须通过 lib/api.ts 服务层并使用 Auth JWT 调用 API

**实施示例**:
```typescript
// lib/api.ts
import { useAuth } from '@/contexts/AuthContext'

export class ApiClient {
  private getAuthHeaders() {
    const { getToken } = useAuth()
    return {
      'Authorization': `Bearer ${getToken()}`,
      'Content-Type': 'application/json'
    }
  }

  async query(question: string): Promise<QueryResponse> {
    const response = await fetch('/api/v1/query', {
      method: 'POST',
      headers: this.getAuthHeaders(),
      body: JSON.stringify({ question })
    })

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`)
    }

    return response.json()
  }
}

// ✅ 正确使用
const apiClient = new ApiClient()
const result = await apiClient.query('What are our sales?')

// ❌ 错误：直接调用 fetch
const response = await fetch('/api/v1/query', { ... })
```

### 规则 3: 环境变量
**要求**: 绝不能在代码中硬编码任何密钥

**实施检查清单**:
```typescript
// ✅ 正确：使用环境变量
const zhipuApiKey = process.env.ZHIPUAI_API_KEY
const dbUrl = process.env.DATABASE_URL

// ❌ 错误：硬编码密钥
const zhipuApiKey = "sk-xxx..."
const dbUrl = "postgresql://user:pass@localhost:5432/db"
```

**配置验证**:
```python
# backend/src/app/core/config.py
from pydantic import BaseSettings, validator

class Settings(BaseSettings):
    ZHIPUAI_API_KEY: str
    DATABASE_URL: str
    CLERK_JWT_PUBLIC_KEY: str

    @validator('ZHIPUAI_API_KEY')
    def validate_zhipu_key(cls, v):
        if not v.startswith('sk-'):
            raise ValueError('Invalid Zhipu API key format')
        return v

    class Config:
        env_file = ".env"
```

### 规则 4: 错误处理
**要求**: 前端必须在 API 调用中使用 finally { setIsLoading(false); }

**实施模式**:
```typescript
const [loading, setLoading] = useState(false)
const [error, setError] = useState<string | null>(null)

const handleQuery = async (question: string) => {
  setLoading(true)
  setError(null)

  try {
    const result = await apiClient.query(question)
    setResult(result)
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Unknown error')
  } finally {
    setLoading(false) // 关键：确保 loading 状态被重置
  }
}
```

### 规则 5: 租户隔离 (V4 核心)
**要求**: 所有后端服务必须接受 tenant_id 并将其用于所有数据检索

**实施要求**:
```python
# agent_core.py
async def process_query(question: str, tenant_id: str):
    # SQL 查询必须包含租户过滤
    sql_result = await sql_chain.execute(question, tenant_id)

    # 向量检索必须包含租户过滤
    rag_result = await rag_chain.execute(question, tenant_id)

    return merge_results(sql_result, rag_result)

# sql_chain.py
async def execute_query(question: str, tenant_id: str):
    # 1. 获取租户的数据库连接
    connection = await get_tenant_connection(tenant_id)

    # 2. 构建租户安全的查询
    safe_query = add_tenant_filter(question, tenant_id)

    # 3. 执行查询
    return await connection.execute(safe_query)

# rag_chain.py
async def retrieve_documents(query: str, tenant_id: str):
    # 向量检索必须包含租户过滤
    results = collection.query(
        query_embeddings=embed_query(query),
        where={"tenant_id": tenant_id}  # 关键：租户隔离
    )
    return results
```

## 代码质量标准

### TypeScript/JavaScript

**命名规范**:
- 组件: PascalCase (`UserProfile.tsx`)
- 函数/变量: camelCase (`getUserData`)
- 常量: UPPER_SNAKE_CASE (`API_BASE_URL`)
- 类型/接口: PascalCase (`QueryResponse`)

**文件组织**:
```
src/
├── components/          # 可复用组件
│   ├── ui/             # shadcn/ui 组件
│   └── features/       # 功能组件
├── hooks/              # 自定义 React Hooks
├── lib/                # 工具函数和 API 客户端
├── types/              # TypeScript 类型定义
└── utils/              # 纯函数工具
```

### Python

**命名规范**:
- 类: PascalCase (`DatabaseManager`)
- 函数/变量: snake_case (`get_user_data`)
- 常量: UPPER_SNAKE_CASE (`DATABASE_URL`)
- 文件: snake_case (`database_manager.py`)

**代码格式化**:
```bash
# 安装开发依赖
pip install black isort flake8 mypy

# 格式化代码
black src/
isort src/

# 类型检查
mypy src/

# 代码质量检查
flake8 src/
```

## Git 工作流规范

### 提交信息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型**:
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式化
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建或辅助工具变动

**示例**:
```
feat(auth): add tenant isolation middleware

- Implement JWT verification for all API endpoints
- Add tenant_id extraction and validation
- Update database queries to include tenant filtering

Closes #123
```

### 分支策略
- `main`: 生产环境代码
- `develop`: 开发环境代码
- `feature/*`: 功能开发分支
- `hotfix/*`: 紧急修复分支

## 代码审查清单

### 安全性
- [ ] 没有硬编码的密钥或敏感信息
- [ ] 所有用户输入都经过验证和清理
- [ ] 租户数据隔离正确实现
- [ ] API 端点都有适当的认证检查

### 性能
- [ ] 数据库查询使用了适当的索引
- [ ] 避免了 N+1 查询问题
- [ ] 实现了必要的缓存策略
- [ ] 前端组件正确使用 memo 和 useMemo

### 可维护性
- [ ] 代码遵循项目规范
- [ ] 函数和组件职责单一
- [ ] 有适当的错误处理
- [ ] 包含必要的测试用例

---
**分片索引**: 13-编码标准.md | **总页数**: 13/17