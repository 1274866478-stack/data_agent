# Change: 修复AI助手编造数据问题 - 强制工具调用和增强幻觉检测

## Why

根据诊断报告（`test-ai-hallucination-diagnosis/DIAGNOSIS_REPORT.md`），AI助手在回答"列出所有的用户"时，返回了编造的假数据（用户1、用户2、用户3、用户4、用户5），而不是从数据库中查询的真实数据。

**根本原因**：
1. **AI没有真正调用工具** - 即使系统有增强提示要求调用工具，AI仍然跳过工具调用步骤
2. **幻觉检测机制未正确触发** - 虽然代码中有检测逻辑，但可能没有正确检测到"用户1"、"用户2"等模式
3. **Prompt规则不够强制** - LLM可能选择忽略提示中的强制要求

这是一个严重的数据准确性问题，会导致用户获得错误的信息，影响系统可信度。

## What Changes

### 优先级1：修复幻觉检测逻辑
- 改进幻觉检测模式匹配，确保能正确检测"用户1"、"用户2"等编号模式
- 增强检测逻辑，确保检测到后能正确拦截并返回错误消息
- 添加更多假数据模式检测（如连续的编号列表）

### 优先级2：强制工具调用验证
- 在Agent执行后验证是否调用了必要工具
- 对于文件数据源，如果没有调用`inspect_file`或`analyze_dataframe`，强制拦截
- 对于SQL数据源，如果没有调用`query`或`execute_sql_safe`，强制拦截
- 添加工具调用验证的日志记录

### 优先级3：增强Prompt规则
- 在System Prompt开头添加最严格的规则
- 使用更明确的格式要求和few-shot示例
- 强化"禁止编造数据"的警告

### 优先级4：改进错误处理
- 当工具返回"SYSTEM ERROR"时，强制AI停止生成答案
- 返回明确的错误消息给用户
- 改进错误消息的用户友好性

### 优先级5：增强日志和监控
- 记录所有工具调用的详细信息
- 记录幻觉检测的详细过程
- 添加数据一致性检查的日志

## Impact

- **受影响的功能**：AI助手查询功能
- **受影响的代码**：
  - `backend/src/app/services/agent/agent_service.py` - Agent服务（幻觉检测、工具调用验证）
  - `backend/src/app/services/agent/prompts.py` - System Prompt（增强规则）
  - `backend/src/app/services/agent/tools.py` - 工具定义（错误处理）
- **影响范围**：所有使用AI助手查询的场景，特别是文件数据源查询
- **预期效果**：
  - AI必须调用工具才能生成答案
  - 幻觉检测能正确识别和拦截假数据
  - 用户收到准确的错误提示而不是假数据

