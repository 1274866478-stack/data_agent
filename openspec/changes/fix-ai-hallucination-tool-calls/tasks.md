# 修复AI助手编造数据问题 - 实施任务清单

## 1. 修复幻觉检测逻辑
- [ ] 1.1 检查并修复"用户1"、"用户2"等编号模式的检测逻辑
  - [ ] 检查`agent_service.py`中的幻觉检测代码（第1360-1448行）
  - [ ] 确保编号模式正则表达式能正确匹配"用户1"、"用户2"等
  - [ ] 测试检测逻辑是否能正确识别这些模式
- [ ] 1.2 增强检测模式列表
  - [ ] 添加更多假数据模式（如"用户ID: 1"、"用户编号: 1"等）
  - [ ] 确保中文和英文模式都能被检测
  - [ ] 测试各种变体模式
- [ ] 1.3 修复拦截逻辑
  - [ ] 确保检测到幻觉后能正确拦截（第1485-1523行）
  - [ ] 验证拦截后的错误消息是否正确返回
  - [ ] 测试拦截机制是否在所有场景下都能工作

## 2. 强制工具调用验证
- [ ] 2.1 添加工具调用验证函数
  - [ ] 在`agent_service.py`中创建`verify_tool_calls`函数
  - [ ] 验证文件数据源是否调用了`inspect_file`和`analyze_dataframe`
  - [ ] 验证SQL数据源是否调用了`query`或`execute_sql_safe`
- [ ] 2.2 在Agent执行后添加验证
  - [ ] 在`run_agent`函数中，收集所有消息后验证工具调用
  - [ ] 如果没有调用必要工具，强制拦截并返回错误消息
  - [ ] 添加详细的日志记录
- [ ] 2.3 测试工具调用验证
  - [ ] 测试文件数据源未调用工具的场景
  - [ ] 测试SQL数据源未调用工具的场景
  - [ ] 验证错误消息是否正确返回

## 3. 增强Prompt规则
- [ ] 3.1 修改System Prompt
  - [ ] 在`prompts.py`的`get_system_prompt`函数开头添加最严格的规则
  - [ ] 明确禁止在没有调用工具的情况下生成数据
  - [ ] 使用更强烈的警告语言
- [ ] 3.2 添加Few-shot示例
  - [ ] 添加正确调用工具的示例
  - [ ] 添加错误行为的示例（并说明为什么错误）
  - [ ] 确保示例清晰易懂
- [ ] 3.3 测试Prompt效果
  - [ ] 测试增强后的Prompt是否能强制AI调用工具
  - [ ] 对比增强前后的行为差异

## 4. 改进错误处理
- [ ] 4.1 增强工具错误处理
  - [ ] 在`tools.py`中，确保工具返回"SYSTEM ERROR"时能被正确识别
  - [ ] 在`agent_service.py`中，检测到"SYSTEM ERROR"时强制停止生成答案
  - [ ] 返回用户友好的错误消息
- [ ] 4.2 改进错误消息
  - [ ] 统一错误消息格式
  - [ ] 提供明确的错误原因和解决建议
  - [ ] 确保错误消息对用户友好
- [ ] 4.3 测试错误处理
  - [ ] 测试工具调用失败时的错误处理
  - [ ] 测试工具返回空数据时的错误处理
  - [ ] 验证错误消息是否正确显示

## 5. 增强日志和监控
- [ ] 5.1 添加工具调用日志
  - [ ] 记录每个工具调用的时间戳、参数和结果
  - [ ] 记录工具调用是否成功
  - [ ] 记录工具返回的数据摘要
- [ ] 5.2 添加幻觉检测日志
  - [ ] 记录幻觉检测的详细过程
  - [ ] 记录检测到的模式和原因
  - [ ] 记录拦截决策和原因
- [ ] 5.3 添加数据一致性检查
  - [ ] 对比工具返回的数据和AI回答中的数据
  - [ ] 记录不一致的地方
  - [ ] 生成数据一致性报告

## 6. 测试和验证
- [ ] 6.1 单元测试
  - [ ] 测试幻觉检测函数
  - [ ] 测试工具调用验证函数
  - [ ] 测试错误处理逻辑
- [ ] 6.2 集成测试
  - [ ] 测试完整的查询流程
  - [ ] 测试文件数据源查询
  - [ ] 测试SQL数据源查询
- [ ] 6.3 回归测试
  - [ ] 测试"列出所有的用户"查询
  - [ ] 验证不再返回假数据
  - [ ] 验证错误消息正确显示
- [ ] 6.4 边界情况测试
  - [ ] 测试空数据源
  - [ ] 测试工具调用失败
  - [ ] 测试特殊字符处理

## 7. 文档更新
- [ ] 7.1 更新代码注释
  - [ ] 为新增的验证逻辑添加注释
  - [ ] 更新幻觉检测逻辑的注释
  - [ ] 更新错误处理的注释
- [ ] 7.2 更新技术文档
  - [ ] 记录修复的问题和解决方案
  - [ ] 更新架构文档（如有需要）
  - [ ] 更新故障排查指南

