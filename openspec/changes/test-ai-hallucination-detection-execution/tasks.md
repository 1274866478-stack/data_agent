## 0. 验证Agent数据库访问能力
- [ ] 0.1 验证Agent能否正常连接到数据库（PostgreSQL/MySQL）
- [ ] 0.2 验证Agent能否执行基本的SQL查询（如`SELECT 1`）
- [ ] 0.3 验证Agent能否查询实际数据表（如`SELECT * FROM users LIMIT 5`）
- [ ] 0.4 验证Agent能否获取数据库schema信息（表名、列名等）
- [ ] 0.5 检查日志中是否有数据库连接错误
- [ ] 0.6 验证MCP客户端是否正常工作
- [ ] 0.7 验证工具调用（`list_tables`, `get_schema`, `query_database`）是否可用

## 1. 验证检测逻辑是否执行
- [ ] 1.1 检查后端日志，查找幻觉检测相关的日志记录
- [ ] 1.2 验证检测逻辑的条件判断（`if final_content and len(final_content.strip()) > 50`）
- [ ] 1.3 确认检测逻辑在流式输出完成后是否执行
- [ ] 1.4 检查是否有"检测到连续的中文测试名字列表"等日志

## 2. 验证拦截逻辑是否工作
- [ ] 2.1 检查如果检测到幻觉，`hallucination_detected`是否正确设置为`True`
- [ ] 2.2 验证`hallucination_reason`是否正确填充
- [ ] 2.3 确认`cleaned_content`和`final_content`是否正确设置为错误消息
- [ ] 2.4 检查`VisualizationResponse.answer`是否正确更新

## 3. 验证响应转换时的检查
- [ ] 3.1 检查`convert_agent_response_to_query_response`是否正确读取`metadata`
- [ ] 3.2 验证如果`hallucination_detected`为`True`，`explanation`是否正确替换
- [ ] 3.3 确认二次检查是否正确执行
- [ ] 3.4 检查是否有"响应转换时检测到幻觉"等日志

## 4. 验证metadata传递
- [ ] 4.1 检查`run_agent`返回的字典中是否包含`metadata`字段
- [ ] 4.2 验证`run_agent_query`是否正确将`metadata`附加到`VisualizationResponse`对象
- [ ] 4.3 确认`convert_agent_response_to_query_response`能否正确读取`metadata`
- [ ] 4.4 检查`metadata`的结构是否正确（包含`hallucination_detected`和`hallucination_reason`）

## 5. 端到端测试
- [ ] 5.1 模拟一个包含"张三"、"李四"等假数据的查询
- [ ] 5.2 跟踪从Agent执行到响应转换的完整流程
- [ ] 5.3 验证每个检查点是否正确工作
- [ ] 5.4 确认用户最终收到的响应是否包含错误消息而不是假数据

## 6. 验证流式输出问题
- [ ] 6.1 检查流式响应是否在检测逻辑执行之前就已经发送给用户
- [ ] 6.2 验证流式输出完成后是否执行了检测逻辑
- [ ] 6.3 检查流式输出时是否有拦截机制
- [ ] 6.4 验证流式输出时metadata是否正确传递

## 7. 验证工具调用被跳过
- [ ] 7.1 检查AI是否调用了必要的工具（inspect_file, analyze_dataframe等）
- [ ] 7.2 验证工具调用验证逻辑是否正确执行
- [ ] 7.3 检查如果工具调用被跳过，是否正确拦截
- [ ] 7.4 验证系统提示词是否足够强调必须调用工具

## 8. 验证工具调用失败但被忽略
- [ ] 8.1 检查工具返回`SYSTEM ERROR`时，AI是否仍然继续生成回答
- [ ] 8.2 验证工具调用失败的错误处理是否正确
- [ ] 8.3 检查AI是否忽略了工具返回的错误信息
- [ ] 8.4 验证系统提示词是否足够强调必须处理工具错误

## 9. 验证空数据处理不当
- [ ] 9.1 检查工具返回空数据时，AI是否仍然继续生成回答
- [ ] 9.2 验证空数据的错误处理是否正确
- [ ] 9.3 检查AI是否忽略了空数据警告
- [ ] 9.4 验证系统提示词是否足够强调必须处理空数据

## 10. 验证数据源类型判断错误
- [ ] 10.1 检查`is_file_datasource`的判断是否正确
- [ ] 10.2 验证数据源类型判断逻辑是否正确执行
- [ ] 10.3 检查如果数据源类型判断错误，是否使用了错误的工具
- [ ] 10.4 验证数据源类型判断的日志记录

## 11. 验证文件路径问题
- [ ] 11.1 检查文件路径是否正确
- [ ] 11.2 验证文件路径是否可访问
- [ ] 11.3 检查文件路径错误时，是否正确处理
- [ ] 11.4 验证文件路径错误的日志记录

## 12. 验证文件权限问题
- [ ] 12.1 检查是否有权限访问文件
- [ ] 12.2 验证文件权限错误时，是否正确处理
- [ ] 12.3 检查文件权限错误的日志记录
- [ ] 12.4 验证文件权限错误时，AI是否仍然继续生成回答

## 13. 验证数据源选择错误
- [ ] 13.1 检查是否正确选择了数据源
- [ ] 13.2 验证数据源选择逻辑是否正确执行
- [ ] 13.3 检查如果选择了错误的数据源，是否导致幻觉
- [ ] 13.4 验证数据源选择的日志记录

## 14. 验证LLM API调用失败
- [ ] 14.1 检查LLM API调用失败时，是否正确处理
- [ ] 14.2 验证LLM API调用失败时，AI是否仍然继续生成回答
- [ ] 14.3 检查LLM API调用失败的日志记录
- [ ] 14.4 验证LLM API调用失败的错误处理

## 15. 验证超时问题
- [ ] 15.1 检查工具调用超时时，是否正确处理
- [ ] 15.2 验证工具调用超时时，AI是否仍然继续生成回答
- [ ] 15.3 检查工具调用超时的日志记录
- [ ] 15.4 验证工具调用超时的错误处理

## 16. 验证缓存问题
- [ ] 16.1 检查是否存在缓存导致使用了旧数据
- [ ] 16.2 验证缓存是否正确清理
- [ ] 16.3 检查缓存是否导致幻觉
- [ ] 16.4 验证缓存的日志记录

## 17. 验证并发问题
- [ ] 17.1 检查多个请求是否导致状态混乱
- [ ] 17.2 验证并发请求时，是否正确处理
- [ ] 17.3 检查并发请求是否导致幻觉
- [ ] 17.4 验证并发请求的日志记录

## 18. 验证错误处理不当
- [ ] 18.1 检查错误是否被吞掉，导致AI继续生成回答
- [ ] 18.2 验证错误处理是否正确
- [ ] 18.3 检查错误处理的日志记录
- [ ] 18.4 验证错误处理是否导致幻觉

## 19. 验证系统提示词强度
- [ ] 19.1 检查系统提示词是否足够强调必须使用真实数据
- [ ] 19.2 验证系统提示词是否足够强调必须调用工具
- [ ] 19.3 检查系统提示词是否足够强调必须处理错误
- [ ] 19.4 验证系统提示词的执行效果

## 20. 验证测试数据污染
- [ ] 20.1 检查测试数据是否包含假数据
- [ ] 20.2 验证测试数据是否正确清理
- [ ] 20.3 检查测试数据是否导致幻觉
- [ ] 20.4 验证测试数据的日志记录

## 21. 生成诊断报告
- [ ] 21.1 汇总所有测试结果
- [ ] 21.2 找出检测逻辑没有生效的根本原因
- [ ] 21.3 提出具体的修复建议

