# Change: 测试AI幻觉检测逻辑执行问题

## Why

虽然我们已经实施了多层幻觉检测和拦截机制，但AI仍然返回假数据（"张三"、"李四"、"王五"、"赵六"）。这说明检测逻辑可能没有正确执行，或者执行了但没有正确拦截。

**问题现象**：
- AI返回了包含"张三"、"李四"、"王五"、"赵六"的回答
- 系统应该检测到这些假数据并拦截，但用户仍然收到了这些数据
- 需要诊断为什么检测逻辑没有生效

**可能的原因**：
0. **数据库访问失败** - Agent无法正常访问数据库，导致无法获取真实数据，从而编造数据
1. **检测逻辑没有执行** - 检测逻辑的条件判断可能有问题，导致没有执行
2. **检测到了但没有拦截** - 检测逻辑执行了，但拦截逻辑没有正确工作
3. **响应转换时检查失败** - 响应转换时的检查可能没有正确执行
4. **metadata没有正确传递** - `hallucination_detected`标志可能没有正确传递到响应转换函数
5. **日志记录不足** - 无法从日志中看到检测逻辑的执行情况
6. **流式输出问题** - 流式响应在检测逻辑执行之前就已经发送给用户了
7. **工具调用被跳过** - AI可能没有调用必要的工具（inspect_file, analyze_dataframe等）
8. **工具调用失败但被忽略** - 工具返回`SYSTEM ERROR`但AI仍然继续生成回答
9. **空数据处理不当** - 即使工具返回空数据，AI也可能继续生成回答
10. **系统提示词不够强** - 提示词可能没有足够强调必须使用真实数据
11. **数据源类型判断错误** - `is_file_datasource`的判断可能有问题，导致使用了错误的工具
12. **文件路径问题** - 文件路径可能不正确，导致无法访问文件
13. **文件权限问题** - 可能没有权限访问文件
14. **数据源选择错误** - 可能选择了错误的数据源
15. **LLM API调用失败** - LLM API调用失败但被忽略，导致AI继续生成回答
16. **超时问题** - 工具调用超时但AI继续生成回答
17. **缓存问题** - 可能存在缓存导致使用了旧数据
18. **并发问题** - 多个请求可能导致状态混乱
19. **错误处理不当** - 错误可能被吞掉，导致AI继续生成回答
20. **测试数据污染** - 测试数据可能包含假数据

## What Changes

### 测试阶段0：验证Agent数据库访问能力
- 验证Agent能否正常连接到数据库
- 验证Agent能否执行基本的SQL查询
- 验证Agent能否查询实际数据表
- 验证Agent能否获取数据库schema信息
- 验证MCP客户端是否正常工作
- 验证工具调用是否可用

### 测试阶段1：验证检测逻辑是否执行
- 检查日志中是否有幻觉检测相关的记录
- 验证检测逻辑的条件判断是否正确
- 确认检测逻辑在正确的时机执行

### 测试阶段2：验证拦截逻辑是否工作
- 检查如果检测到幻觉，是否正确设置了`hallucination_detected`标志
- 验证`cleaned_content`和`final_content`是否正确设置为错误消息
- 确认`VisualizationResponse.answer`是否正确更新

### 测试阶段3：验证响应转换时的检查
- 检查`convert_agent_response_to_query_response`是否正确检查了`metadata.hallucination_detected`
- 验证二次检查是否正确执行
- 确认`explanation`字段是否正确替换为错误消息

### 测试阶段4：验证metadata传递
- 检查`run_agent`返回的字典中是否包含`metadata`
- 验证`metadata`是否正确附加到`VisualizationResponse`对象
- 确认`convert_agent_response_to_query_response`能否正确读取`metadata`

### 测试阶段5：端到端测试
- 模拟完整的查询流程
- 验证从Agent执行到响应转换的完整链路
- 确认用户最终收到的响应是否正确

## Impact

- **测试范围**：AI助手查询功能、幻觉检测逻辑、响应转换逻辑
- **测试方法**：日志分析、代码检查、端到端测试
- **预期结果**：找出为什么检测逻辑没有生效的根本原因

