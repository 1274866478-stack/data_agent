# 测试计划实施任务清单

## 1. 测试环境准备
- [ ] 1.1 准备测试数据库（包含标准测试数据）
- [ ] 1.2 准备测试Excel文件（包含中文数据）
- [ ] 1.3 配置测试环境日志级别（启用详细日志）
- [ ] 1.4 创建测试数据验证脚本

## 2. 阶段1：基础验证测试
- [ ] 2.1 测试数据库连接和工具可用性
  - [ ] 验证数据库连接字符串
  - [ ] 手动调用 `list_tables` 工具
  - [ ] 手动调用 `get_schema` 工具
  - [ ] 手动调用 `query_database` 工具
  - [ ] 手动调用 `inspect_file` 工具（文件数据源）
  - [ ] 手动调用 `analyze_dataframe` 工具（文件数据源）
- [ ] 2.2 验证Agent初始化
  - [ ] 检查Agent是否成功初始化
  - [ ] 检查工具是否正确加载
  - [ ] 检查System Prompt是否正确注入

## 3. 阶段2：工具调用流程测试
- [ ] 3.1 简单查询测试
  - [ ] 测试问题："数据库中有哪些表？"
  - [ ] 测试问题："用户表的结构是什么？"
  - [ ] 测试问题："查询前5条用户记录"
  - [ ] 验证AI是否调用了正确的工具
  - [ ] 验证AI回答是否基于工具返回的真实数据
- [ ] 3.2 工具调用失败场景测试
  - [ ] 模拟 `list_tables` 工具调用失败
  - [ ] 模拟 `query_database` 工具调用失败
  - [ ] 模拟工具返回空结果
  - [ ] 验证AI是否明确告知工具调用失败
  - [ ] 验证AI是否编造了数据
- [ ] 3.3 数据一致性验证测试
  - [ ] 测试问题："查询用户表中所有用户的姓名和邮箱"
  - [ ] 手动执行相同SQL查询获取真实数据
  - [ ] 对比AI回答中的数据与真实数据
  - [ ] 生成数据一致性对比报告

## 4. 阶段3：Prompt和响应生成测试
- [ ] 4.1 Prompt有效性测试
  - [ ] 检查System Prompt内容
  - [ ] 验证Prompt中是否包含"禁止编造数据"规则
  - [ ] 验证Prompt中是否包含"必须使用工具返回的数据"规则
  - [ ] 测试不同强度的Prompt版本
- [ ] 4.2 响应生成流程测试
  - [ ] 记录完整的消息流（HumanMessage、AIMessage、ToolMessage）
  - [ ] 分析工具返回的数据是否被正确传递
  - [ ] 检查AI的最终回答是否引用了工具返回的数据

## 5. 阶段4：端到端集成测试
- [ ] 5.1 完整查询流程测试
  - [ ] 测试问题："数据库中有哪些表？"
  - [ ] 测试问题："用户表的结构是什么？"
  - [ ] 测试问题："查询前10条用户记录"
  - [ ] 测试问题："统计每个部门的员工数量"
  - [ ] 验证每个问题都触发了正确的工具调用
  - [ ] 验证AI回答基于真实数据
- [ ] 5.2 边界情况测试
  - [ ] 测试数据库为空的情况
  - [ ] 测试查询结果为空的情况
  - [ ] 测试查询结果包含特殊字符的情况
  - [ ] 测试查询结果包含大量数据的情况
  - [ ] 测试数据库连接超时的情况

## 6. 阶段5：日志分析和诊断
- [ ] 6.1 日志收集和分析
  - [ ] 收集Agent初始化日志
  - [ ] 收集工具调用日志（输入、输出、耗时）
  - [ ] 收集LLM请求日志
  - [ ] 收集消息流日志
  - [ ] 分析工具调用成功率
  - [ ] 分析工具调用失败的原因
  - [ ] 分析AI回答与工具返回数据的一致性
- [ ] 6.2 问题根源定位
  - [ ] 对比正常情况和异常情况
  - [ ] 分析日志中的关键事件
  - [ ] 检查代码中的关键逻辑
  - [ ] 生成诊断报告

## 7. 测试脚本开发
- [ ] 7.1 创建工具调用测试脚本 (`scripts/test_tool_calls.py`)
- [ ] 7.2 创建Agent执行测试脚本 (`scripts/test_agent_execution.py`)
- [ ] 7.3 创建数据一致性验证脚本 (`scripts/validate_data_consistency.py`)
- [ ] 7.4 创建日志分析脚本 (`scripts/analyze_logs.py`)

## 8. 测试报告生成
- [ ] 8.1 生成阶段1测试报告
- [ ] 8.2 生成阶段2测试报告
- [ ] 8.3 生成阶段3测试报告
- [ ] 8.4 生成阶段4测试报告
- [ ] 8.5 生成阶段5诊断报告
- [ ] 8.6 生成综合诊断报告（包含问题根源分析和修复建议）

