## 1. 修复响应转换逻辑
- [ ] 1.1 在`convert_agent_response_to_query_response`函数中添加幻觉检测检查
- [ ] 1.2 如果检测到幻觉，强制使用错误消息替换`explanation`字段
- [ ] 1.3 确保`metadata.hallucination_detected`标志能正确传递到响应转换函数

## 2. 修复检测逻辑执行时机
- [ ] 2.1 确保检测逻辑在流式输出完成后立即执行
- [ ] 2.2 在检测到幻觉时，立即更新`VisualizationResponse.answer`字段
- [ ] 2.3 验证`cleaned_content`和`final_content`是否正确设置

## 3. 增强检测条件
- [ ] 3.1 放宽检测逻辑的执行条件
- [ ] 3.2 改进检测模式匹配，确保能检测到"张三"、"李四"等模式
- [ ] 3.3 添加更详细的日志记录

## 4. 在响应转换时强制检查
- [ ] 4.1 在`convert_agent_response_to_query_response`中添加二次检查
- [ ] 4.2 即使`answer`字段包含假数据，也要在转换时拦截
- [ ] 4.3 添加响应级别的幻觉检测作为最后一道防线

## 5. 测试和验证
- [ ] 5.1 测试包含"张三"、"李四"等假数据的响应是否能被正确拦截
- [ ] 5.2 验证响应转换时是否正确应用了幻觉检测
- [ ] 5.3 检查日志，确认检测逻辑正确执行

