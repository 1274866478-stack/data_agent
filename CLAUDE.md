# Data Agent V4 - AIåŠ©æ‰‹ä¸Šä¸‹æ–‡æŒ‡å—

**é¡¹ç›®**: å¤šç§Ÿæˆ·SaaSæ•°æ®æ™ºèƒ½åˆ†æå¹³å°
**ç‰ˆæœ¬**: V4.1 (SaaS MVP)
**æŠ€æœ¯æ ˆ**: Next.js 14 + FastAPI + PostgreSQL + Docker + LangGraph
**æœ€åæ›´æ–°**: 2025-12-05 11:43:00

---

## é¡¹ç›®æ„¿æ™¯

Data Agent V4 æ˜¯ä¸€ä¸ªäº‘å°±ç»ªçš„å¤šç§Ÿæˆ·SaaSå¹³å°ï¼Œä¸“æ³¨äº"BYO-Data"(è‡ªå¸¦æ•°æ®)çš„æ™ºèƒ½æ•°æ®åˆ†ææœåŠ¡ã€‚æ ¸å¿ƒä»·å€¼åœ¨äºï¼š

- ğŸ” **å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»**: ä¼ä¸šçº§å®‰å…¨æ€§ä¸ç§Ÿæˆ·éš”ç¦»
- ğŸ§  **AIé©±åŠ¨åˆ†æ**: åŸºäºæ™ºè°±(Zhipu)AIçš„æ™ºèƒ½æ•°æ®æ´å¯Ÿ
- ğŸ“Š **è‡ªå¸¦æ•°æ®åº“**: ç”¨æˆ·å®‰å…¨è¿æ¥å¤–éƒ¨PostgreSQLæ•°æ®æº
- ğŸ“š **çŸ¥è¯†åº“å¢å¼º**: PDF/Wordæ–‡æ¡£ä¸Šä¼ ä¸å‘é‡æ£€ç´¢
- ğŸš€ **äº‘åŸç”Ÿæ¶æ„**: Dockerå®¹å™¨åŒ–ï¼Œæ”¯æŒå¿«é€Ÿäº‘éƒ¨ç½²

---

## æ¨¡å—ç»“æ„å›¾

```mermaid
graph TD
    A["(æ ¹) Data Agent V4"] --> B["backend"];
    A --> C["frontend"];
    A --> D["docs"];
    A --> E["scripts"];
    A --> F["Agent"];

    B --> G["src/app"];
    G --> H["api"];
    G --> I["core"];
    G --> J["data"];
    G --> K["services"];

    H --> L["v1/endpoints"];
    L --> M["health"];
    L --> N["tenants"];
    L --> O["documents"];
    L --> P["data_sources"];
    L --> Q["auth"];
    L --> R["llm"];

    I --> S["config"];
    I --> T["logging"];
    I --> U["security"];

    J --> V["models"];
    J --> W["database"];

    K --> X["minio_client"];
    K --> Y["chromadb_client"];
    K --> Z["zhipu_client"];
    K --> AA["llm_service"];

    C --> BB["src/app"];
    C --> CC["package.json"];
    C --> DD["tsconfig.json"];

    F --> EE["sql_agent.py"];
    F --> FF["chart_service.py"];
    F --> GG["data_transformer.py"];
    F --> HH["terminal_viz.py"];
    F --> II["charts/"];

    click B "./backend/CLAUDE.md" "æŸ¥çœ‹åç«¯æ¨¡å—æ–‡æ¡£"
    click C "./frontend/CLAUDE.md" "æŸ¥çœ‹å‰ç«¯æ¨¡å—æ–‡æ¡£"
    click D "./docs/CLAUDE.md" "æŸ¥çœ‹æ–‡æ¡£æ¨¡å—"
    click E "./scripts/CLAUDE.md" "æŸ¥çœ‹è„šæœ¬æ¨¡å—"
    click F "./Agent/CLAUDE.md" "æŸ¥çœ‹Agentæ¨¡å—æ–‡æ¡£"
```

---

## æ¨¡å—ç´¢å¼•

| æ¨¡å—è·¯å¾„ | èŒè´£æè¿° | æŠ€æœ¯æ ˆ | çŠ¶æ€ | æµ‹è¯•è¦†ç›– |
|---------|----------|--------|------|----------|
| [backend](./backend/CLAUDE.md) | FastAPIåç«¯æœåŠ¡ï¼ŒAPIæ¥å£ï¼Œä¸šåŠ¡é€»è¾‘ | Python 3.8+, FastAPI, SQLAlchemy | âœ… æ ¸å¿ƒå®Œæˆ | 75% |
| [frontend](./frontend/CLAUDE.md) | Next.jså‰ç«¯åº”ç”¨ï¼Œç”¨æˆ·ç•Œé¢ï¼Œäº¤äº’ä½“éªŒ | Next.js 14, TypeScript, Tailwind CSS | ğŸš§ åŸºç¡€å®Œæˆ | 30% |
| [Agent](./Agent/CLAUDE.md) | LangGraph SQLæ™ºèƒ½ä»£ç†ï¼Œè‡ªç„¶è¯­è¨€æŸ¥è¯¢ä¸å›¾è¡¨å¯è§†åŒ– | LangGraph, DeepSeek, MCP, PyEcharts | ğŸ†• æ–°å¢æ¨¡å— | 40% |
| [docs](./docs/CLAUDE.md) | é¡¹ç›®æ–‡æ¡£ï¼ŒPRDï¼Œæ¶æ„è®¾è®¡ï¼Œç”¨æˆ·æ•…äº‹ | Markdown | âœ… å®Œæ•´ | - |
| [scripts](./scripts/CLAUDE.md) | è‡ªåŠ¨åŒ–è„šæœ¬ï¼ŒDockerç®¡ç†ï¼Œé…ç½®éªŒè¯ | Shell, Batch, Python | âœ… å®ç”¨å·¥å…· | 60% |
| **[Bugä¿®å¤æ—¥å¿—](./docs/bug-fixes-log.md)** | **å†å²é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ** | Markdown | ğŸ”´ å¿…è¯» | - |

---

## è¿è¡Œä¸å¼€å‘

### å¿«é€Ÿå¯åŠ¨
```bash
# 1. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¿…éœ€ï¼‰
cp .env.example .env
# ç¼–è¾‘ .env è®¾ç½®å…³é”®é…ç½®ï¼šZHIPUAI_API_KEY, MINIO_ACCESS_KEY, MINIO_SECRET_KEY

# 2. Dockeræ–¹å¼å¯åŠ¨ï¼ˆæ¨èï¼‰
docker-compose up -d

# 3. éªŒè¯æœåŠ¡çŠ¶æ€
curl http://localhost:8004/health
```

### æœ¬åœ°å¼€å‘
```bash
# åç«¯å¼€å‘
cd backend
pip install -r requirements.txt
uvicorn src.app.main:app --reload --port 8004

# å‰ç«¯å¼€å‘
cd frontend
npm install
npm run dev
```

### æœåŠ¡ç«¯å£
| æœåŠ¡ | ç«¯å£ | æè¿° |
|------|------|------|
| å‰ç«¯ | 3000 | Next.jsåº”ç”¨ |
| åç«¯API | 8004 | FastAPIæœåŠ¡ |
| PostgreSQL | 5432 | ä¸»æ•°æ®åº“ |
| MinIO API | 9000 | å¯¹è±¡å­˜å‚¨ |
| MinIO Console | 9001 | å­˜å‚¨ç®¡ç†ç•Œé¢ |
| ChromaDB | 8001 | å‘é‡æ•°æ®åº“ |

---

## æ ¸å¿ƒåŠŸèƒ½æ¶æ„

### å¤šç§Ÿæˆ·è®¤è¯
- **æ‰˜ç®¡è®¤è¯**: é›†æˆClerkè®¤è¯æœåŠ¡ï¼Œæ”¯æŒç”¨æˆ·æ³¨å†Œ/ç™»å½•
- **ç§Ÿæˆ·éš”ç¦»**: åŸºäºtenant_idçš„å®Œå…¨æ•°æ®éš”ç¦»
- **JWTéªŒè¯**: APIçº§åˆ«çš„èº«ä»½éªŒè¯å’Œæˆæƒ

### æ•°æ®è¿æ¥ç®¡ç†
- **å¤–éƒ¨æ•°æ®åº“**: æ”¯æŒPostgreSQLè¿æ¥å­—ç¬¦ä¸²å¯¼å…¥
- **æ–‡æ¡£ä¸Šä¼ **: MinIOå¯¹è±¡å­˜å‚¨ï¼Œæ”¯æŒPDF/Word
- **å‘é‡åŒ–**: ChromaDBå‘é‡æ•°æ®åº“ï¼Œæ”¯æŒè¯­ä¹‰æ£€ç´¢

### AIåˆ†æå¼•æ“
- **LLMæœåŠ¡**: æ™ºè°±GLM-4-flashæ¨¡å‹é›†æˆ + DeepSeek API
- **LangGraph Agent**: ç‹¬ç«‹SQLæ™ºèƒ½ä»£ç†ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢
- **MCPåè®®**: Model Context Protocol è¿æ¥æ•°æ®åº“
- **å¤šè½®å¯¹è¯**: æ”¯æŒä¸Šä¸‹æ–‡ç†è§£çš„å¯¹è¯å¼åˆ†æ
- **å›¾è¡¨å¯è§†åŒ–**: è‡ªåŠ¨ç”ŸæˆEChartså›¾è¡¨
- **ç»“æœæº¯æº**: XAIå¯è§£é‡Šæ¨ç†è·¯å¾„

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•å±‚çº§
1. **å•å…ƒæµ‹è¯•**: æœåŠ¡å±‚å’Œå·¥å…·å‡½æ•°æµ‹è¯•
2. **é›†æˆæµ‹è¯•**: APIç«¯ç‚¹å’Œæ•°æ®åº“äº¤äº’æµ‹è¯•
3. **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´ç”¨æˆ·æµç¨‹æµ‹è¯•
4. **æ€§èƒ½æµ‹è¯•**: å“åº”æ—¶é—´å’Œå¹¶å‘æµ‹è¯•

### æµ‹è¯•è¿è¡Œ
```bash
# åç«¯æµ‹è¯•
cd backend
pytest tests/ -v --cov

# å‰ç«¯æµ‹è¯•
cd frontend
npm test
```

### å…³é”®æµ‹è¯•è¦†ç›–
- âœ… å¥åº·æ£€æŸ¥API
- âœ… ç§Ÿæˆ·ç®¡ç†CRUD
- âœ… MinIOæ–‡ä»¶æ“ä½œ
- âœ… ChromaDBå‘é‡æ“ä½œ
- ğŸš§ æ™ºè°±AIé›†æˆæµ‹è¯•
- ğŸš§ æ•°æ®æºè¿æ¥æµ‹è¯•

---

## ç¼–ç è§„èŒƒ

### åç«¯è§„èŒƒ (Python)
- **ä»£ç é£æ ¼**: Black + isort + flake8
- **ç±»å‹æ£€æŸ¥**: mypy strictæ¨¡å¼
- **æ–‡æ¡£**: Googleé£æ ¼docstring
- **æµ‹è¯•**: pytest + pytest-asyncio
- **å¼‚æ­¥**: å…¨ç¨‹async/awaitæ¨¡å¼

### å‰ç«¯è§„èŒƒ (TypeScript)
- **ä»£ç é£æ ¼**: ESLint + Prettier
- **ç±»å‹å®‰å…¨**: strict TypeScriptæ¨¡å¼
- **ç»„ä»¶**: å‡½æ•°å¼ç»„ä»¶ + Hooks
- **çŠ¶æ€ç®¡ç†**: Zustandè½»é‡çŠ¶æ€
- **æ ·å¼**: Tailwind CSS utility classes

### æ•°æ®åº“è§„èŒƒ
- **è¿ç§»**: Alembicç‰ˆæœ¬æ§åˆ¶
- **ORM**: SQLAlchemy 2.0 async
- **ç´¢å¼•**: tenant_id + ä¸šåŠ¡å­—æ®µå¤åˆç´¢å¼•
- **çº¦æŸ**: å¤–é”®çº¦æŸ + æ•°æ®å®Œæ•´æ€§

---

## AIåŠ©æ‰‹ä½¿ç”¨æŒ‡å¼•

### å¼€å‘åŠ©æ‰‹è§’è‰²
ä½œä¸ºAIåŠ©æ‰‹ï¼Œä½ åº”è¯¥ï¼š

#### ğŸ¯ æ ¸å¿ƒèŒè´£
1. **ä»£ç å®¡æŸ¥**: å…³æ³¨å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å’Œå®‰å…¨æ€§
2. **APIè®¾è®¡**: éµå¾ªRESTfulå’ŒFastAPIæœ€ä½³å®è·µ
3. **æ€§èƒ½ä¼˜åŒ–**: æ•°æ®åº“æŸ¥è¯¢å’Œå“åº”æ—¶é—´ä¼˜åŒ–
4. **æµ‹è¯•å»ºè®®**: æä¾›å…¨é¢çš„æµ‹è¯•è¦†ç›–å»ºè®®

#### ğŸ”§ é‡ç‚¹å…³æ³¨
- **ç§Ÿæˆ·éš”ç¦»**: ç¡®ä¿æ‰€æœ‰æ•°æ®æ“ä½œéƒ½åŒ…å«tenant_idè¿‡æ»¤
- **å¼‚æ­¥æ¨¡å¼**: åç«¯æœåŠ¡å¿…é¡»ä½¿ç”¨async/await
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **é…ç½®ç®¡ç†**: æ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†

#### ğŸ“‹ å¸¸è§ä»»åŠ¡
- æ·»åŠ æ–°çš„APIç«¯ç‚¹æ—¶ï¼Œç¡®ä¿åŒ…å«é€‚å½“çš„ç§Ÿæˆ·éš”ç¦»
- å‰ç«¯ç»„ä»¶å¼€å‘æ—¶ï¼Œéµå¾ªTypeScriptä¸¥æ ¼ç±»å‹æ£€æŸ¥
- æ•°æ®åº“æ¨¡å‹å˜æ›´æ—¶ï¼Œåˆ›å»ºå¯¹åº”çš„Alembicè¿ç§»
- æ€§èƒ½é—®é¢˜æ’æŸ¥æ—¶ï¼Œæ£€æŸ¥è¿æ¥æ± å’ŒæŸ¥è¯¢ä¼˜åŒ–

#### âš ï¸ æ³¨æ„äº‹é¡¹
- **å®‰å…¨**: æ°¸è¿œä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç APIå¯†é’¥æˆ–æ•æ„Ÿä¿¡æ¯
- **æµ‹è¯•**: æ–°åŠŸèƒ½å¿…é¡»åŒ…å«ç›¸åº”çš„å•å…ƒæµ‹è¯•
- **æ–‡æ¡£**: APIå˜æ›´éœ€è¦æ›´æ–°å¯¹åº”çš„æ¥å£æ–‡æ¡£
- **å…¼å®¹æ€§**: ç¡®ä¿å‘åå…¼å®¹æ€§å’Œç‰ˆæœ¬æ§åˆ¶

---

## éƒ¨ç½²ä¸è¿ç»´

### Dockerå®¹å™¨åŒ–
- **å¤šé˜¶æ®µæ„å»º**: ä¼˜åŒ–é•œåƒå¤§å°
- **å¥åº·æ£€æŸ¥**: æ‰€æœ‰æœåŠ¡åŒ…å«å¥åº·æ£€æŸ¥ç«¯ç‚¹
- **ç¯å¢ƒéš”ç¦»**: å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒé…ç½®åˆ†ç¦»

### ç›‘æ§ä¸æ—¥å¿—
- **ç»“æ„åŒ–æ—¥å¿—**: ä½¿ç”¨structlogè®°å½•JSONæ ¼å¼æ—¥å¿—
- **æ€§èƒ½ç›‘æ§**: è¯·æ±‚æ—¶é—´å’ŒæœåŠ¡çŠ¶æ€ç›‘æ§
- **é”™è¯¯è¿½è¸ª**: å®Œæ•´çš„é”™è¯¯å †æ ˆå’Œä¸Šä¸‹æ–‡

### å®‰å…¨æªæ–½
- **å¯†é’¥ç®¡ç†**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å®‰å…¨çš„å¯†é’¥è½®æ¢
- **ç½‘ç»œå®‰å…¨**: CORSé…ç½®å’ŒAPIè®¤è¯
- **æ•°æ®åŠ å¯†**: ä¼ è¾“å’Œå­˜å‚¨æ•°æ®åŠ å¯†

---

## ğŸ”´ å¸¸è§é—®é¢˜ä¸å¼€å‘è§„é¿ (å¿…è¯»)

> **å‚è€ƒå®Œæ•´æ—¥å¿—**: [docs/bug-fixes-log.md](./docs/bug-fixes-log.md) - åŒ…å«è¯¦ç»†çš„é—®é¢˜æè¿°ã€æ ¹å› åˆ†æå’Œè§£å†³æ–¹æ¡ˆ

### å‰ç«¯å¼€å‘è§„èŒƒ

| è§„åˆ™ | è¯´æ˜ | åä¾‹ | æ­£ä¾‹ |
|------|------|------|------|
| **APIå¿…é¡»ä½¿ç”¨å®Œæ•´URL** | å‰åç«¯è¿è¡Œåœ¨ä¸åŒç«¯å£ï¼Œç›¸å¯¹è·¯å¾„ä¼šå‘åˆ°å‰ç«¯æœåŠ¡å™¨ | `fetch('/api/v1/...')` | `fetch(\`${process.env.NEXT_PUBLIC_API_URL}/...\`)` |
| **å¤šç§Ÿæˆ·APIå¿…é¡»ä¼ é€’tenant_id** | æ‰€æœ‰æ•°æ®æ“ä½œéœ€è¦ç§Ÿæˆ·éš”ç¦» | `fetch('/data-sources')` | `fetch('/data-sources?tenant_id=xxx&user_id=xxx')` |
| **é»˜è®¤ç­›é€‰åº”åªæ˜¾ç¤ºæ´»è·ƒæ•°æ®** | è½¯åˆ é™¤çš„æ•°æ®ä¸åº”é»˜è®¤æ˜¾ç¤º | `filterStatus='all'` | `filterStatus='active'` |
| **ç±»å‹åç§°éœ€å‰åç«¯ä¸€è‡´** | é¿å…å‘½åä¸åŒ¹é…å¯¼è‡´æŸ¥è¯¢å¤±è´¥ | `type='databases'` | `type='database'` |

### åç«¯å¼€å‘è§„èŒƒ

| è§„åˆ™ | è¯´æ˜ | åä¾‹ | æ­£ä¾‹ |
|------|------|------|------|
| **FastAPIè·¯ç”±é¡ºåº** | å›ºå®šè·¯å¾„å¿…é¡»åœ¨åŠ¨æ€è·¯å¾„ä¹‹å‰ | `/{id}` åœ¨ `/search` ä¹‹å‰ | `/search` åœ¨ `/{id}` ä¹‹å‰ |
| **é¿å…å˜é‡é®è”½** | å‚æ•°åä¸è¦ä¸å¯¼å…¥æ¨¡å—åŒå | `def func(status: str): status.HTTP_400` | `def func(status_filter: str): status.HTTP_400` |
| **ä½¿ç”¨æ­£ç¡®çš„æ¨¡å‹å­—æ®µ** | Tenantä½¿ç”¨statusæšä¸¾ï¼Œéis_active | `Tenant.is_active == True` | `Tenant.status == TenantStatus.ACTIVE` |
| **æ–‡ä»¶ä¸Šä¼ éœ€æ‰‹åŠ¨è·å–tenant_id** | Formæ•°æ®ä¸Queryå‚æ•°éœ€åˆ†åˆ«å¤„ç† | `tenant_id: str = None` | `tenant_id = request.query_params.get("tenant_id")` |
| **æ–°å¢ä¾èµ–åæ›´æ–°requirements** | é¿å…éƒ¨ç½²æ—¶ç¼ºå°‘æ¨¡å— | åªimportä¸æ›´æ–°requirements | `pip freeze` æˆ–æ‰‹åŠ¨æ·»åŠ  |

### LLMæœåŠ¡å¼€å‘è§„èŒƒ

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **Promptä¸­å¼ºè°ƒSchemaä¿¡æ¯** | ä½¿ç”¨é†’ç›®æ ‡è®°(ğŸ”´ğŸ”´ğŸ”´)æé†’AIä¸¥æ ¼éµå®ˆåˆ—å |
| **SQLä¿®å¤æˆåŠŸåæ›¿æ¢åŸå†…å®¹** | ä¸è¦åŒæ—¶æ˜¾ç¤ºé”™è¯¯SQLå’Œä¿®å¤åSQL |
| **ä¿®å¤å¤±è´¥åªæ˜¾ç¤ºä¸€æ¬¡é”™è¯¯** | é¿å…é‡å¤æ˜¾ç¤ºä¸­é—´é‡è¯•çš„é”™è¯¯ä¿¡æ¯ |

### æœåŠ¡å¯åŠ¨æ£€æŸ¥æ¸…å•

```bash
# 1. æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
netstat -ano | findstr "8004" | findstr "LISTENING"

# 2. æ£€æŸ¥å‰ç«¯æ˜¯å¦è¿è¡Œ
netstat -ano | findstr "3000" | findstr "LISTENING"

# 3. éªŒè¯APIå¥åº·
curl http://localhost:8004/health

# 4. éªŒè¯æ•°æ®æ¥å£
curl "http://localhost:8004/api/v1/data-sources/overview?tenant_id=default_tenant"
```

---

## å˜æ›´è®°å½• (Changelog)

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´ç±»å‹ | æè¿° | ä½œè€… |
|------|------|----------|------|------|
| 2025-12-05 | V4.1 | ğŸ†• æ–°å¢ | æ·»åŠ LangGraph SQL Agentæ¨¡å—ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢å’Œå›¾è¡¨å¯è§†åŒ– | AI Assistant |
| 2025-12-01 | V4.1 | ğŸ“š æ–°å¢ | æ·»åŠ å¸¸è§é—®é¢˜è§„é¿ç« èŠ‚ï¼Œæ•´åˆbugä¿®å¤æ—¥å¿— | AI Assistant |
| 2025-11-18 | V4.1 | ğŸ”„ æ›´æ–° | AIä¸Šä¸‹æ–‡å®Œæ•´åˆå§‹åŒ–ï¼Œæ¨¡å—æ–‡æ¡£å®Œå–„ | AI Assistant |
| 2025-11-17 | V4.1 | ğŸ†• æ–°å¢ | AIä¸Šä¸‹æ–‡åˆå§‹åŒ–æ–‡æ¡£åˆ›å»º | AI Assistant |
| 2025-11-16 | V4.1 | ğŸ”§ æ›´æ–° | æ ¸å¿ƒLLMä¾èµ–åˆ‡æ¢ä¸ºæ™ºè°±API | John |
| 2025-11-15 | V4.0 | ğŸ”„ é‡æ„ | ä»V3æœ¬åœ°Demoè½¬å‘V4 SaaS MVP | John |

---

**ğŸ‘‹ AIåŠ©æ‰‹ä½ å¥½ï¼ä½¿ç”¨è¿™ä»½æŒ‡å—å¯ä»¥å¿«é€Ÿç†è§£é¡¹ç›®æ¶æ„ï¼Œé«˜æ•ˆå‚ä¸å¼€å‘å·¥ä½œã€‚é‡åˆ°é—®é¢˜æ—¶ï¼Œä¼˜å…ˆæŸ¥çœ‹å¯¹åº”æ¨¡å—çš„è¯¦ç»†æ–‡æ¡£ã€‚**