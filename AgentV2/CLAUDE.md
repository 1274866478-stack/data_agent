# Agent æ¨¡å— - LangGraph SQL æ™ºèƒ½ä»£ç†

**æ¨¡å—**: ç‹¬ç«‹SQLæ™ºèƒ½ä»£ç†ä¸å›¾è¡¨å¯è§†åŒ–æœåŠ¡
**ç‰ˆæœ¬**: V1.0
**æŠ€æœ¯æ ˆ**: LangGraph + DeepSeek + MCP + PyEcharts
**æœ€åæ›´æ–°**: 2025-12-05 11:43:00

---

## æ¨¡å—æ¦‚è¿°

Agent æ¨¡å—æ˜¯åŸºäº LangGraph å’Œ MCP (Model Context Protocol) çš„ SQL æ™ºèƒ½æŸ¥è¯¢ä»£ç†ï¼Œæä¾›è‡ªç„¶è¯­è¨€æ•°æ®åº“æŸ¥è¯¢å’Œè‡ªåŠ¨å›¾è¡¨å¯è§†åŒ–åŠŸèƒ½ã€‚

---

## æ ¸å¿ƒåŠŸèƒ½

### ğŸ¤– æ™ºèƒ½SQLæŸ¥è¯¢
- **è‡ªç„¶è¯­è¨€ç†è§£**: ä½¿ç”¨ DeepSeek LLM è§£æç”¨æˆ·æŸ¥è¯¢æ„å›¾
- **Schema è‡ªåŠ¨å‘ç°**: è‡ªåŠ¨è·å–æ•°æ®åº“è¡¨ç»“æ„å’Œå­—æ®µä¿¡æ¯
- **å®‰å…¨æŸ¥è¯¢æ‰§è¡Œ**: ä»…æ‰§è¡Œ SELECT æŸ¥è¯¢ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
- **é”™è¯¯å¤„ç†**: æ™ºèƒ½SQLé”™è¯¯ä¿®å¤å’Œé‡è¯•æœºåˆ¶

### ğŸ“Š å›¾è¡¨å¯è§†åŒ–
- **è‡ªåŠ¨å›¾è¡¨é€‰æ‹©**: æ ¹æ®æ•°æ®ç±»å‹æ™ºèƒ½é€‰æ‹©åˆé€‚çš„å›¾è¡¨ç±»å‹
- **å¤šç§å›¾è¡¨æ”¯æŒ**: æŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ã€æ•£ç‚¹å›¾ã€é›·è¾¾å›¾ã€æ¼æ–—å›¾
- **EChartsé›†æˆ**: ç”Ÿæˆé«˜è´¨é‡çš„äº¤äº’å¼HTMLå›¾è¡¨
- **æœ¬åœ°å›¾è¡¨ç”Ÿæˆ**: æ”¯æŒæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå›¾è¡¨ä¿å­˜

### ğŸ”„ LangGraphå·¥ä½œæµ
- **çŠ¶æ€ç®¡ç†**: åŸºäºMessagesStateçš„å¤šè½®å¯¹è¯çŠ¶æ€
- **å·¥å…·ç¼–æ’**: æ™ºèƒ½å·¥å…·è°ƒç”¨å’Œæµç¨‹æ§åˆ¶
- **è®°å¿†åŠŸèƒ½**: å†…ç½®MemorySaveræ”¯æŒå¯¹è¯å†å²

---

## æ–‡ä»¶ç»“æ„

```
Agent/
â”œâ”€â”€ sql_agent.py              # ğŸ¯ ä¸»ç¨‹åºå…¥å£ - LangGraph Agentå®ç°
â”œâ”€â”€ config.py                 # âš™ï¸ é…ç½®ç®¡ç† - APIå¯†é’¥å’Œæ•°æ®åº“è¿æ¥
â”œâ”€â”€ models.py                 # ğŸ“‹ æ•°æ®æ¨¡å‹ - Pydanticæ¨¡å‹å®šä¹‰
â”œâ”€â”€ chart_service.py          # ğŸ“Š å›¾è¡¨æœåŠ¡ - EChartsç”Ÿæˆæ¥å£
â”œâ”€â”€ data_transformer.py       # ğŸ”„ æ•°æ®è½¬æ¢ - SQLç»“æœåˆ°å›¾è¡¨æ•°æ®
â”œâ”€â”€ terminal_viz.py           # ğŸ–¥ï¸ ç»ˆç«¯å¯è§†åŒ– - Richåº“ç»ˆç«¯è¾“å‡º
â”œâ”€â”€ run_query.py              # ğŸƒ æŸ¥è¯¢æ‰§è¡Œå™¨ - ç‹¬ç«‹æŸ¥è¯¢è„šæœ¬
â”œâ”€â”€ setup_test_db.py          # ğŸ§ª æµ‹è¯•æ•°æ®åº“è®¾ç½®
â”œâ”€â”€ requirements.txt          # ğŸ“¦ Pythonä¾èµ–ç®¡ç†
â”œâ”€â”€ .env.example              # ğŸ”§ ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ run.py                    # ğŸš€ å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ run.sh / run.bat          # ğŸ–¥ï¸ å¹³å°å¯åŠ¨è„šæœ¬
â”œâ”€â”€ start-echarts-mcp.bat     # ğŸ“ˆ ECharts MCPæœåŠ¡å¯åŠ¨
â”œâ”€â”€ charts/                   # ğŸ“ å›¾è¡¨è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ *.html               # ç”Ÿæˆçš„HTMLå›¾è¡¨æ–‡ä»¶
â”‚   â””â”€â”€ output.png           # ç¤ºä¾‹å›¾è¡¨è¾“å‡º
â””â”€â”€ README.md                # ğŸ“– æ¨¡å—è¯´æ˜æ–‡æ¡£
```

---

## æŠ€æœ¯æ¶æ„

### ä¾èµ–æ ˆ
| æŠ€æœ¯ç±»åˆ« | å…·ä½“æŠ€æœ¯ | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€”æè¿° |
|---------|----------|----------|----------|
| **AIæ¡†æ¶** | LangGraph | >=0.2.0 | æ™ºèƒ½ä½“å·¥ä½œæµç¼–æ’ |
| **LLM** | DeepSeek API | OpenAIå…¼å®¹ | è‡ªç„¶è¯­è¨€ç†è§£ |
| **MCPåè®®** | langchain-mcp-adapters | >=0.1.0 | æ•°æ®åº“è¿æ¥åè®® |
| **æ•°æ®åº“** | PostgreSQL | >=12 | ä¸»æ•°æ®å­˜å‚¨ |
| **å¯è§†åŒ–** | PyEcharts | >=2.0.0 | å›¾è¡¨ç”Ÿæˆå¼•æ“ |
| **ç»ˆç«¯** | Rich | >=13.0.0 | ç¾åŒ–ç»ˆç«¯è¾“å‡º |

### MCPå·¥å…·é›†æˆ
```python
# PostgreSQL MCPæœåŠ¡å™¨
postgres_tools = [
    "list_tables",      # åˆ—å‡ºæ•°æ®åº“è¡¨
    "get_schema",       # è·å–è¡¨ç»“æ„
    "query"            # æ‰§è¡ŒSQLæŸ¥è¯¢
]

# ECharts MCPæœåŠ¡å™¨
chart_tools = [
    "generate_bar_chart",      # æŸ±çŠ¶å›¾
    "generate_line_chart",     # æŠ˜çº¿å›¾
    "generate_pie_chart",      # é¥¼å›¾
    "generate_scatter_chart",  # æ•£ç‚¹å›¾
    "generate_radar_chart",    # é›·è¾¾å›¾
    "generate_funnel_chart",   # æ¼æ–—å›¾
    "generate_echarts"         # é€šç”¨å›¾è¡¨
]
```

---

## ä½¿ç”¨æ–¹å¼

### 1. ç‹¬ç«‹è¿è¡ŒAgent
```bash
# è¿›å…¥Agentç›®å½•
cd Agent

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env è®¾ç½® DEEPSEEK_API_KEY å’Œ DATABASE_URL

# å¯åŠ¨Agent
python sql_agent.py
```

### 2. é›†æˆåˆ°ä¸»é¡¹ç›®
```python
# åœ¨FastAPIä¸­ä½¿ç”¨Agent
from Agent.sql_agent import run_agent

@app.post("/api/v1/natural-query")
async def natural_language_query(
    question: str,
    tenant_id: str,
    user_id: str
):
    result = await run_agent(question)
    return {
        "tenant_id": tenant_id,
        "user_id": user_id,
        "result": result
    }
```

### 3. ä½¿ç”¨ç¤ºä¾‹å¯¹è¯
```
ğŸ“ è¯·è¾“å…¥ä½ çš„é—®é¢˜: æ•°æ®åº“é‡Œæœ‰å“ªäº›è¡¨ï¼Ÿ

ğŸ”§ è°ƒç”¨å·¥å…·: ['list_tables']
ğŸ’¬ å›ç­”: æ•°æ®åº“ä¸­åŒ…å«ä»¥ä¸‹è¡¨ï¼šusers, orders, products...

ğŸ“ è¯·è¾“å…¥ä½ çš„é—®é¢˜: ç”»å‡ºæ¯ä¸ªæœˆçš„è®¢å•æ•°é‡è¶‹åŠ¿å›¾

ğŸ”§ è°ƒç”¨å·¥å…·: ['get_schema', 'query', 'generate_line_chart']
ğŸ’¬ å›ç­”: å·²ç”Ÿæˆè®¢å•æ•°é‡è¶‹åŠ¿å›¾ï¼Œä¿å­˜è‡³ charts/chart_line_*.html
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡
```env
# DeepSeek APIé…ç½®
DEEPSEEK_API_KEY=your_api_key_here
DEEPSEEK_BASE_URL=https://api.deepseek.com

# æ•°æ®åº“è¿æ¥
DATABASE_URL=postgresql://user:password@localhost:5432/your_database

# å›¾è¡¨è¾“å‡ºé…ç½®
CHART_OUTPUT_DIR=./charts
```

### Agenté…ç½®
```python
# config.py ä¸»è¦é…ç½®é¡¹
class Config:
    # LLMé…ç½®
    model="deepseek-chat",
    temperature=0.1,
    max_tokens=2000

    # MCPæœåŠ¡å™¨é…ç½®
    mcp_servers = {
        "postgres": {
            "command": "npx",
            "args": ["@modelcontextprotocol/server-postgres", DATABASE_URL],
        },
        "echarts": {
            "command": "npx",
            "args": ["@modelcontextprotocol/server-echarts"]
        }
    }
```

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„å›¾è¡¨ç±»å‹
1. åœ¨ `chart_service.py` ä¸­æ·»åŠ æ–°çš„å›¾è¡¨ç”Ÿæˆå‡½æ•°
2. æ›´æ–° `data_transformer.py` ä¸­çš„æ•°æ®è½¬æ¢é€»è¾‘
3. åœ¨Agentçš„system promptä¸­æ·»åŠ æ–°å·¥å…·è¯´æ˜

### æ‰©å±•æ•°æ®åº“æ”¯æŒ
1. å®‰è£…å¯¹åº”æ•°æ®åº“çš„MCPæœåŠ¡å™¨
2. æ›´æ–° `config.py` ä¸­çš„mcp_serversé…ç½®
3. ä¿®æ”¹SQLç”Ÿæˆæ¨¡æ¿ä»¥é€‚é…æ–°æ•°æ®åº“æ–¹è¨€

### è‡ªå®šä¹‰Agentè¡Œä¸º
```python
# ä¿®æ”¹system promptè‡ªå®šä¹‰Agentè¡Œä¸º
SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®åˆ†æåŠ©æ‰‹...
æ–°å¢åŠŸèƒ½æè¿°...
"""
```

---

## æµ‹è¯•ä¸è°ƒè¯•

### å•å…ƒæµ‹è¯•
```bash
# è¿è¡Œæµ‹è¯•ï¼ˆéœ€æ·»åŠ pytesté…ç½®ï¼‰
pytest tests/ -v
```

### è°ƒè¯•æ¨¡å¼
```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)

# æŸ¥çœ‹LangGraphæ‰§è¡Œæµç¨‹
agent.get_graph().print_ascii()
```

### å¸¸è§é—®é¢˜æ’æŸ¥
1. **MCPæœåŠ¡å™¨è¿æ¥å¤±è´¥**: æ£€æŸ¥Node.jså’Œnpxå®‰è£…
2. **æ•°æ®åº“è¿æ¥é”™è¯¯**: éªŒè¯DATABASE_URLæ ¼å¼å’Œæƒé™
3. **DeepSeek APIé”™è¯¯**: ç¡®è®¤API Keyæœ‰æ•ˆæ€§å’Œç½‘ç»œè¿æ¥
4. **å›¾è¡¨ç”Ÿæˆå¤±è´¥**: æ£€æŸ¥æ•°æ®æ ¼å¼å’ŒECharts MCPæœåŠ¡çŠ¶æ€

---

## æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢ä¼˜åŒ–
- æ·»åŠ æŸ¥è¯¢è¶…æ—¶æ§åˆ¶
- å®ç°ç»“æœç¼“å­˜æœºåˆ¶
- é™åˆ¶æŸ¥è¯¢è¿”å›è¡Œæ•°

### å›¾è¡¨ä¼˜åŒ–
- æ§åˆ¶æ•°æ®ç‚¹æ•°é‡é¿å…æ€§èƒ½é—®é¢˜
- ä½¿ç”¨æ•°æ®é‡‡æ ·å¤„ç†å¤§æ•°æ®é›†
- å›¾è¡¨æ‡’åŠ è½½å’ŒæŒ‰éœ€ç”Ÿæˆ

---

## å®‰å…¨è€ƒè™‘

### æ•°æ®å®‰å…¨
- âœ… åªè¯»æ¨¡å¼ï¼Œä»…å…è®¸SELECTæŸ¥è¯¢
- âœ… æŸ¥è¯¢ç»“æœå¤§å°é™åˆ¶
- âœ… æ•æ„Ÿå­—æ®µè‡ªåŠ¨è„±æ•ï¼ˆå¯æ‰©å±•ï¼‰

### APIå®‰å…¨
- ğŸ” APIå¯†é’¥ç¯å¢ƒå˜é‡ç®¡ç†
- ğŸš« é¿å…SQLæ³¨å…¥ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- ğŸ“ æŸ¥è¯¢æ—¥å¿—è®°å½•å’Œå®¡è®¡

---

## ä¸ä¸»é¡¹ç›®é›†æˆç‚¹

### 1. APIé›†æˆ
- åœ¨ `backend/src/app/api/v1/endpoints/` ä¸­æ·»åŠ æ–°çš„æŸ¥è¯¢ç«¯ç‚¹
- å¤ç”¨ç°æœ‰çš„ç§Ÿæˆ·éš”ç¦»å’Œè®¤è¯æœºåˆ¶

### 2. å‰ç«¯é›†æˆ
- åœ¨ `frontend/src/components/` ä¸­æ·»åŠ è‡ªç„¶è¯­è¨€æŸ¥è¯¢ç»„ä»¶
- é›†æˆå›¾è¡¨å±•ç¤ºç»„ä»¶ï¼Œæ”¯æŒEChartsæ¸²æŸ“

### 3. æ•°æ®æºé›†æˆ
- è¿æ¥åˆ°ç°æœ‰çš„æ•°æ®æºç®¡ç†ç³»ç»Ÿ
- æ”¯æŒå¤šç§Ÿæˆ·æ•°æ®åº“è¿æ¥é…ç½®

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| V1.0 | 2025-12-05 | ğŸ‰ åˆå§‹ç‰ˆæœ¬å‘å¸ƒï¼Œæ”¯æŒåŸºç¡€SQLæŸ¥è¯¢å’Œå›¾è¡¨ç”Ÿæˆ |

---

**ğŸ‘‹ å¼€å‘è€…æç¤ºï¼šè¿™ä¸ªæ¨¡å—è®¾è®¡ä¸ºç‹¬ç«‹å¯æ’æ‹”çš„ç»„ä»¶ï¼Œå¯ä»¥å•ç‹¬å¼€å‘æµ‹è¯•ï¼Œä¹Ÿå¯ä»¥æ— ç¼é›†æˆåˆ°ä¸»Data Agentå¹³å°ä¸­ã€‚**