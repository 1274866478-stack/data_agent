# AgentV2 - LangChain DeepAgents å‡çº§æ–¹æ¡ˆ

## æ¦‚è¿°

å°†ç°æœ‰ Agent æ¨¡å—ä» LangGraph è¿ç§»åˆ° LangChain DeepAgents æ¡†æ¶ï¼Œå®ç° SOTA çº§åˆ«çš„æ™ºèƒ½æ•°æ®åˆ†æèƒ½åŠ›ã€‚

### ç”¨æˆ·é€‰æ‹©
- **è¿ç§»æ–¹å¼**: å®Œæ•´è¿ç§» DeepAgents
- **MCP ç­–ç•¥**: ä¿ç•™ç°æœ‰ MCP åè®®ï¼ˆPostgreSQL + EChartsï¼‰
- **éƒ¨ç½²æ–¹å¼**: é›†æˆåˆ° FastAPI åç«¯
- **ç›®æ ‡**: å‡çº§åˆ° SOTA çº§åˆ«ï¼Œå¼•å…¥ DeepAgents çš„å…¨éƒ¨æ ¸å¿ƒèƒ½åŠ›

---

## æ¶æ„è®¾è®¡

### æ–°ç›®å½•ç»“æ„

```
AgentV2/
â”œâ”€â”€ core/                        # æ ¸å¿ƒ Agent å®ç°
â”‚   â”œâ”€â”€ agent_factory.py         # DeepAgents å·¥å‚ â­
â”‚   â”œâ”€â”€ base_agent.py            # åŸºç¡€ Agent ç±»
â”‚   â”œâ”€â”€ state_manager.py         # çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ memory.py                # è®°å¿†ç³»ç»Ÿ
â”‚
â”œâ”€â”€ middleware/                  # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ sql_security.py          # SQL å®‰å…¨æ ¡éªŒ
â”‚   â”œâ”€â”€ data_transformer.py      # æ•°æ®è½¬æ¢
â”‚   â”œâ”€â”€ chart_generator.py       # å›¾è¡¨ç”Ÿæˆ
â”‚   â”œâ”€â”€ tenant_isolation.py      # ç§Ÿæˆ·éš”ç¦» â­
â”‚   â””â”€â”€ xai_logger.py            # XAI å¯è§£é‡Šæ€§æ—¥å¿— â­
â”‚
â”œâ”€â”€ tools/                       # å·¥å…·é›†
â”‚   â”œâ”€â”€ mcp_tools.py             # MCP å·¥å…·åŒ…è£… â­
â”‚   â”œâ”€â”€ sql_tools.py             # SQL æŸ¥è¯¢å·¥å…·
â”‚   â”œâ”€â”€ file_tools.py            # æ–‡ä»¶åˆ†æå·¥å…·
â”‚   â””â”€â”€ chart_tools.py           # å›¾è¡¨å·¥å…·
â”‚
â”œâ”€â”€ subagents/                   # å­ä»£ç† â­
â”‚   â”œâ”€â”€ sql_agent.py             # SQL ä¸“å®¶å­ä»£ç†
â”‚   â”œâ”€â”€ file_agent.py            # æ–‡ä»¶åˆ†æå­ä»£ç†
â”‚   â”œâ”€â”€ chart_agent.py           # å›¾è¡¨ä¸“å®¶å­ä»£ç†
â”‚   â””â”€â”€ research_agent.py        # ç ”ç©¶å­ä»£ç†
â”‚
â”œâ”€â”€ config/                      # é…ç½®
â”‚   â”œâ”€â”€ agent_config.py          # Agent é…ç½®
â”‚   â”œâ”€â”€ prompts.py               # ç³»ç»Ÿæç¤ºè¯
â”‚   â””â”€â”€ database_specs.py        # æ•°æ®åº“è§„èŒƒ
â”‚
â”œâ”€â”€ models/                      # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ requests.py              # è¯·æ±‚æ¨¡å‹
â”‚   â”œâ”€â”€ responses.py             # å“åº”æ¨¡å‹
â”‚   â””â”€â”€ internal.py              # å†…éƒ¨æ¨¡å‹
â”‚
â””â”€â”€ tests/                       # æµ‹è¯•
    â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
    â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
    â””â”€â”€ e2e/                     # ç«¯åˆ°ç«¯æµ‹è¯•
```

### æ ¸å¿ƒæ¨¡å—å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI Backend                             â”‚
â”‚  /api/v2/query - æ–°ç‰ˆæŸ¥è¯¢ç«¯ç‚¹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AgentFactory (å·¥å‚æ¨¡å¼)                          â”‚
â”‚  - create_agent() - åˆ›å»º DeepAgents å®ä¾‹                     â”‚
â”‚  - get_or_create_agent() - å•ä¾‹ç¼“å­˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DeepAgents æ ¸å¿ƒå±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Middleware Pipeline (ä¸­é—´ä»¶ç®¡é“)                      â”‚   â”‚
â”‚  â”‚  1. TenantIsolationMiddleware  (ç§Ÿæˆ·éš”ç¦»)              â”‚   â”‚
â”‚  â”‚  2. TodoListMiddleware        (ä»»åŠ¡è§„åˆ’)               â”‚   â”‚
â”‚  â”‚  3. FilesystemMiddleware      (æ–‡ä»¶ç³»ç»Ÿ)               â”‚   â”‚
â”‚  â”‚  4. SubAgentMiddleware        (å­ä»£ç†)                 â”‚   â”‚
â”‚  â”‚  5. SQLSecurityMiddleware     (SQLå®‰å…¨)                â”‚   â”‚
â”‚  â”‚  6. XAILoggerMiddleware       (å¯è§£é‡Šæ€§)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         â”‚                            â”‚    â”‚
â”‚  â–¼                         â–¼                            â–¼    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ SQL Agent    â”‚  â”‚ File Agent   â”‚  â”‚ Chart Agent  â”‚       â”‚
â”‚  â”‚ å­ä»£ç†        â”‚  â”‚ å­ä»£ç†        â”‚  â”‚ å­ä»£ç†        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tools (å·¥å…·é›†)                                        â”‚   â”‚
â”‚  â”‚  - MCP PostgreSQL Tools (ä¿ç•™)                        â”‚   â”‚
â”‚  â”‚  - MCP ECharts Tools (ä¿ç•™)                           â”‚   â”‚
â”‚  â”‚  - Custom Analysis Tools                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### Phase 0: å‡†å¤‡é˜¶æ®µ (1-2å¤©)

**ä»»åŠ¡**:
- [ ] åˆ›å»º AgentV2 ç›®å½•ç»“æ„
- [ ] å®‰è£… DeepAgents ä¾èµ– (`pip install deepagents langgraph>=0.2.50`)
- [ ] é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¤åˆ¶ Agent/.envï¼‰
- [ ] å¤‡ä»½ç°æœ‰ Agent ä»£ç 
- [ ] åˆ›å»º Git åˆ†æ”¯ `feature/deepagents-migration`

**å…³é”®æ–‡ä»¶**:
- `AgentV2/requirements.txt`
- `AgentV2/.env`

**éªŒè¯**: ä¾èµ–å®‰è£…æˆåŠŸï¼Œç¯å¢ƒé…ç½®æ­£ç¡®

---

### Phase 1: DeepAgents åŸºç¡€é›†æˆ (3-5å¤©)

**ç›®æ ‡**: ç”¨ DeepAgents æ›¿æ¢ç°æœ‰ LangGraph æ¶æ„

**æ ¸å¿ƒæ–‡ä»¶**:

#### `AgentV2/core/agent_factory.py` â­
```python
from deepagents import create_deep_agent
from deepagents.middleware import (
    TodoListMiddleware,
    FilesystemMiddleware,
    SubAgentMiddleware
)

class AgentFactory:
    """DeepAgents å·¥å‚ç±»"""

    def __init__(self, config: AgentConfig):
        self.config = config
        self._cached_agent = None

    def create_agent(self, tenant_id: str, database_url: str, tools: list):
        """åˆ›å»º Data Agent V2 å®ä¾‹"""
        middleware = self._build_middleware(tenant_id)

        agent = create_deep_agent(
            model=self.config.model,
            tools=tools,
            middleware=middleware
        )
        return agent

    def _build_middleware(self, tenant_id: str):
        """æ„å»ºä¸­é—´ä»¶åˆ—è¡¨"""
        return [
            TenantIsolationMiddleware(tenant_id),
            TodoListMiddleware(),
            FilesystemMiddleware(),
            SQLSecurityMiddleware(),
            XAILoggerMiddleware()
        ]
```

#### `AgentV2/tools/mcp_tools.py` â­
```python
"""MCP å·¥å…·åŒ…è£…å±‚ - ä¿ç•™ç°æœ‰ MCP é›†æˆ"""
from langchain_mcp_adapters.client import MultiServerMCPClient

async def get_mcp_tools(database_url: str):
    """è·å– MCP å·¥å…·"""
    client = MultiServerMCPClient({
        "postgres": {
            "command": "npx",
            "args": ["@modelcontextprotocol/server-postgres", database_url]
        },
        "echarts": {
            "command": "npx",
            "args": ["@modelcontextprotocol/server-echarts"]
        }
    })
    return await client.get_tools()
```

**è¿ç§»æ˜ å°„**:
| ç°æœ‰ä»£ç  | æ–°ä½ç½® | è¿ç§»æ–¹å¼ |
|---------|--------|---------|
| `Agent/sql_agent.py` | `AgentV2/core/base_agent.py` | é‡å†™ |
| `Agent/config.py` | `AgentV2/config/agent_config.py` | æ‰©å±• |

**éªŒè¯**: åŸºç¡€æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸

---

### Phase 2: ä¸­é—´ä»¶å¢å¼º (5-7å¤©)

**ç›®æ ‡**: é›†æˆç°æœ‰å®‰å…¨å’ŒæœåŠ¡é€»è¾‘åˆ°ä¸­é—´ä»¶

**å…³é”®æ–‡ä»¶**:

#### `AgentV2/middleware/tenant_isolation.py` â­
```python
class TenantIsolationMiddleware(Middleware):
    """å¤šç§Ÿæˆ·éš”ç¦»ä¸­é—´ä»¶"""

    def __init__(self, tenant_id: str):
        super().__init__()
        self.tenant_id = tenant_id

    def pre_process(self, agent_input: Dict) -> Dict:
        agent_input["tenant_id"] = self.tenant_id
        return agent_input
```

#### `AgentV2/middleware/sql_security.py`
```python
class SQLSecurityMiddleware(Middleware):
    """SQL å®‰å…¨æ ¡éªŒä¸­é—´ä»¶ - ä» sql_validator.py è¿ç§»"""

    def __init__(self):
        super().__init__()
        self.dangerous_keywords = ['DROP', 'DELETE', 'INSERT', 'UPDATE', ...]

    def validate_sql(self, sql: str) -> tuple[bool, str]:
        """éªŒè¯ SQL å®‰å…¨æ€§"""
        # å®ç°éªŒè¯é€»è¾‘
        pass
```

#### `AgentV2/middleware/xai_logger.py` â­
```python
class XAILoggerMiddleware(Middleware):
    """XAI å¯è§£é‡Šæ€§æ—¥å¿—ä¸­é—´ä»¶"""

    def post_process(self, agent_output: Dict) -> Dict:
        reasoning_log = {
            "timestamp": datetime.utcnow().isoformat(),
            "steps": self._extract_reasoning_steps(agent_output),
            "tools_used": self._extract_tool_calls(agent_output),
            "decisions": self._extract_decision_points(agent_output)
        }
        agent_output["xai_log"] = reasoning_log
        return agent_output
```

**éªŒè¯**: å®‰å…¨æ ¡éªŒæ­£å¸¸ï¼Œæ—¥å¿—è®°å½•å®Œæ•´

---

### Phase 3: å­ä»£ç†æ¶æ„ (7-10å¤©)

**ç›®æ ‡**: å®ç°ä¸“ä¸šåŒ–å­ä»£ç†

**å…³é”®æ–‡ä»¶**:

#### `AgentV2/subagents/__init__.py` â­
```python
from deepagents.middleware.subagents import SubAgentMiddleware

def create_data_agent_subagents():
    """åˆ›å»ºæ•°æ®åˆ†æå­ä»£ç†"""
    return SubAgentMiddleware(
        default_model="deepseek-chat",
        subagents=[
            create_sql_subagent(),
            create_file_subagent(),
            create_chart_subagent()
        ]
    )
```

#### `AgentV2/subagents/sql_agent.py`
```python
def create_sql_subagent() -> Dict:
    """SQL ä¸“å®¶å­ä»£ç†"""
    return {
        "name": "sql_expert",
        "description": "SQL æŸ¥è¯¢å’Œä¼˜åŒ–ä¸“å®¶",
        "system_prompt": """ä½ æ˜¯ SQL ä¸“å®¶...
- ç†è§£å¤æ‚æŸ¥è¯¢éœ€æ±‚
- ç”Ÿæˆé«˜æ•ˆ SQL è¯­å¥
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- è¯Šæ–­ SQL é”™è¯¯""",
        "tools": [list_tables, get_schema, execute_sql, optimize_query],
        "model": "deepseek-chat"
    }
```

**å­ä»£ç†è®¾è®¡**:
```
Main Agent (åè°ƒè€…)
    â”œâ”€â”€ SQL Agent (æŸ¥è¯¢ä¸“å®¶)
    â”œâ”€â”€ File Agent (æ–‡ä»¶åˆ†æ)
    â”œâ”€â”€ Chart Agent (å¯è§†åŒ–)
    â””â”€â”€ Research Agent (æ·±åº¦ç ”ç©¶)
```

**éªŒè¯**: å­ä»£ç†æ­£ç¡®å§”æ´¾ä»»åŠ¡

---

### Phase 4: é«˜çº§ç‰¹æ€§ (10-14å¤©)

**ç›®æ ‡**: å®ç° SOTA çº§åˆ«åŠŸèƒ½

**å…³é”®å®ç°**:

#### æŒä¹…åŒ–è®°å¿†ç³»ç»Ÿ
```python
# AgentV2/core/memory.py
from langgraph.store.postgres import AsyncPostgresStore
from deepagents.backends import CompositeBackend, StateBackend, StoreBackend

def create_persistent_memory_backend(connection_string: str):
    """åˆ›å»ºæŒä¹…åŒ–è®°å¿†åç«¯"""
    store = AsyncPostgresStore(connection_string)
    return lambda rt: CompositeBackend(
        default=StateBackend(rt),
        routes={
            "/memories/query_history/": StoreBackend(rt),
            "/memories/user_preferences/": StoreBackend(rt),
            "/memories/chart_templates/": StoreBackend(rt),
        }
    )
```

#### å¤šç§Ÿæˆ·ä¸Šä¸‹æ–‡éš”ç¦»
- ç§Ÿæˆ·çº§è®°å¿†éš”ç¦»
- æŸ¥è¯¢å†å²åˆ†ç¦»
- å®‰å…¨ç­–ç•¥éš”ç¦»

**éªŒè¯**: è®°å¿†æŒä¹…åŒ–æ­£å¸¸ï¼Œç§Ÿæˆ·éš”ç¦»æœ‰æ•ˆ

---

### Phase 5: ä¼˜åŒ–ä¸éƒ¨ç½² (14-16å¤©)

**ç›®æ ‡**: æ€§èƒ½ä¼˜åŒ–å’Œç”Ÿäº§éƒ¨ç½²

**å…³é”®æ–‡ä»¶**:

#### `backend/src/app/api/v1/endpoints/query_v2.py` â­
```python
from AgentV2.core.agent_factory import AgentFactory

@router.post("/api/v2/query")
async def create_query_v2(
    request: QueryRequestV2,
    tenant=Depends(get_current_tenant_from_request),
    agent_factory: AgentFactory = Depends(get_agent_factory)
):
    """Data Agent V2 æŸ¥è¯¢ç«¯ç‚¹"""
    # è·å–æ•°æ®æºè¿æ¥
    database_url = await get_database_url(request.connection_id, tenant.id)

    # è·å–æˆ–åˆ›å»º Agent
    agent = await agent_factory.get_or_create_agent(
        tenant_id=tenant.id,
        database_url=database_url
    )

    # æ‰§è¡ŒæŸ¥è¯¢
    result = await agent.ainvoke(
        {"messages": [HumanMessage(content=request.query)]},
        config={"configurable": {"thread_id": f"{tenant.id}_{request.session_id}"}}
    )

    return QueryResponseV2(
        answer=result["messages"][-1].content,
        processing_steps=result.get("xai_log", {}).get("steps", []),
        todos=result.get("todos", []),
        subagent_calls=result.get("subagent_calls", [])
    )
```

**ä¼˜åŒ–ä»»åŠ¡**:
- è¿æ¥æ± ä¼˜åŒ–
- æŸ¥è¯¢ç¼“å­˜
- å¹¶å‘å¤„ç†
- ç›‘æ§å’Œæ—¥å¿—

**éªŒè¯**: æ€§èƒ½è¾¾æ ‡ï¼Œéƒ¨ç½²æˆåŠŸ

---

## ä»£ç è¿ç§»æ˜ å°„è¡¨

### æ ¸å¿ƒæ¨¡å—

| ç°æœ‰æ¨¡å— | æ–°ä½ç½® | è¿ç§»ç­–ç•¥ | å¤æ‚åº¦ |
|---------|--------|---------|--------|
| `Agent/sql_agent.py` | `AgentV2/core/base_agent.py` | é‡å†™ | â­â­â­â­â­ |
| `Agent/config.py` | `AgentV2/config/agent_config.py` | æ‰©å±• | â­â­ |
| `Agent/models.py` | `AgentV2/models/` | ä¿ç•™ | â­ |
| `Agent/data_transformer.py` | `AgentV2/middleware/data_transformer.py` | é‡æ„ | â­â­â­ |
| `Agent/prompt_generator.py` | `AgentV2/config/prompts.py` | ä¿ç•™æ‰©å±• | â­â­ |
| `Agent/sql_validator.py` | `AgentV2/middleware/sql_security.py` | è¿ç§» | â­â­â­ |
| `Agent/chart_service.py` | `AgentV2/middleware/chart_generator.py` | è¿ç§» | â­â­â­ |

### åç«¯é›†æˆ

| ç°æœ‰ç«¯ç‚¹ | æ–°ç«¯ç‚¹ | å˜æ›´è¯´æ˜ |
|---------|--------|---------|
| `/api/v1/query` | `/api/v2/query` | ä½¿ç”¨ DeepAgents |
| `agent_service.py` | `agent_service_v2.py` | ä½¿ç”¨ AgentFactory |

---

## é£é™©è¯„ä¼°ä¸ç¼“è§£

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|---------|
| DeepAgents API ä¸ç¨³å®š | ğŸ”´ é«˜ | Phase 1 å°è§„æ¨¡éªŒè¯ + ä¿ç•™ V1 å›é€€ |
| æ€§èƒ½ä¸‹é™ | ğŸŸ¡ ä¸­ | åŸºå‡†æµ‹è¯• + è¿æ¥æ± ä¼˜åŒ– |
| ä¸­é—´ä»¶å†²çª | ğŸŸ¡ ä¸­ | å•å…ƒæµ‹è¯• + é›†æˆéªŒè¯ |
| ä¾èµ–å…¼å®¹æ€§ | ğŸŸ¢ ä½ | è™šæ‹Ÿç¯å¢ƒéš”ç¦» |

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- `tests/unit/test_agent_factory.py` - AgentFactory æµ‹è¯•
- `tests/unit/test_middleware.py` - ä¸­é—´ä»¶æµ‹è¯•
- `tests/unit/test_tools.py` - å·¥å…·æµ‹è¯•

### é›†æˆæµ‹è¯•
- `tests/integration/test_query_flow.py` - æŸ¥è¯¢æµç¨‹æµ‹è¯•
- `tests/integration/test_subagent_flow.py` - å­ä»£ç†æµ‹è¯•

### æ€§èƒ½æµ‹è¯•
- ç®€å•æŸ¥è¯¢: <3s
- å¤æ‚æŸ¥è¯¢: <12s
- å¹¶å‘å¤„ç†: >15 req/s

### å›å½’æµ‹è¯•
- V1 vs V2 è¾“å‡ºä¸€è‡´æ€§éªŒè¯

---

## éªŒè¯æ–¹æ¡ˆ

### åŠŸèƒ½éªŒè¯
| åŠŸèƒ½ | éªŒè¯æ–¹æ³• | é¢„æœŸç»“æœ |
|------|---------|---------|
| SQL æŸ¥è¯¢ | å•å…ƒæµ‹è¯• | ä¸ V1 ä¸€è‡´ |
| æ–‡ä»¶åˆ†æ | é›†æˆæµ‹è¯• | æ­£ç¡®è§£æ |
| å›¾è¡¨ç”Ÿæˆ | è§†è§‰éªŒè¯ | ECharts æ­£ç¡® |
| å¤šè½®å¯¹è¯ | å›å½’æµ‹è¯• | ä¸Šä¸‹æ–‡ä¿æŒ |
| å­ä»£ç†å§”æ´¾ | E2E æµ‹è¯• | æ­£ç¡®å§”æ´¾ |

### æ€§èƒ½éªŒè¯
| æŒ‡æ ‡ | V1 åŸºå‡† | V2 ç›®æ ‡ |
|------|---------|---------|
| ç®€å•æŸ¥è¯¢ | <3s | <3s |
| å¤æ‚æŸ¥è¯¢ | <15s | <12s |
| å¹¶å‘å¤„ç† | 10 req/s | 15 req/s |

---

## å…³é”®æ–‡ä»¶æ¸…å• â­

å®æ–½æ­¤æ–¹æ¡ˆçš„**æœ€å…³é”®æ–‡ä»¶**ï¼š

1. **`AgentV2/core/agent_factory.py`** - DeepAgents å·¥å‚ç±»
2. **`AgentV2/tools/mcp_tools.py`** - MCP å·¥å…·åŒ…è£…
3. **`AgentV2/middleware/tenant_isolation.py`** - ç§Ÿæˆ·éš”ç¦»
4. **`AgentV2/middleware/xai_logger.py`** - å¯è§£é‡Šæ€§æ—¥å¿—
5. **`AgentV2/subagents/__init__.py`** - å­ä»£ç†é…ç½®
6. **`backend/src/app/api/v1/endpoints/query_v2.py`** - æ–°ç‰ˆ API

---

## å‚è€ƒèµ„æ–™

- [DeepAgents å®˜æ–¹æ–‡æ¡£](https://docs.langchain.com/oss/python/deepagents)
- [LangChain GitHub](https://github.com/langchain-ai/deepagents)
- [ç°æœ‰ Agent æ–‡æ¡£](../Agent/README.md)


é¡¹ç›®æ¨¡å—ç»“æ„

è¯¥é¡¹ç›®æŒ‰èŒè´£åˆ’åˆ†ä¸ºå¤šä¸ªå­æ¨¡å—ï¼šchainsã€toolsã€baseã€serverç­‰ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œchains æ¨¡å—è´Ÿè´£å®šä¹‰é«˜çº§æµç¨‹ï¼ˆChainï¼‰ï¼Œå°†å¤šä¸ªæ“ä½œä¸²è”æˆå®Œæ•´çš„æ¨ç†é“¾è·¯ï¼›tools æ¨¡å—å°è£…å…·ä½“åŠŸèƒ½æ¥å£ï¼Œå¦‚æ•°æ®åº“æŸ¥è¯¢ã€LLMè°ƒç”¨ã€å›¾è¡¨ç”Ÿæˆç­‰ï¼›base æ¨¡å—æä¾›é€šç”¨åŸºç±»å’Œè¾…åŠ©å‡½æ•°ï¼ˆå¦‚ Agent åŸºç±»ã€çŠ¶æ€æœºåŸºç±»ç­‰ï¼‰ï¼Œä¾›å…¶ä»–æ¨¡å—ç»§æ‰¿ï¼›server æ¨¡å—åŸºäº FastAPI å¼€å‘ï¼Œå¯¹å¤–æä¾› HTTP æ¥å£å’Œå¯è§†åŒ–æœåŠ¡ï¼Œä¾‹å¦‚æ¥æ”¶ç”¨æˆ·è¯·æ±‚ã€è¿”å›ç»“æœæˆ– ECharts å›¾è¡¨é…ç½®ã€‚LangChain æ¡†æ¶å†…ç½®äº†â€œæ¨¡å‹/å·¥å…·æ•´åˆâ€èƒ½åŠ›ï¼Œå…è®¸è½»æ¾å°†ä»»æ„å·¥å…·æ³¨å†Œä¸ºæ™ºèƒ½ä½“å¯è°ƒç”¨çš„æ¥å£ï¼›FastAPI åˆ™æ˜¯ä¸€ä¸ªç°ä»£ã€é«˜æ€§èƒ½çš„ Python Web æ¡†æ¶ï¼Œéå¸¸é€‚åˆç”¨äºå¿«é€Ÿæ„å»º RESTful APIã€‚å› æ­¤ï¼Œé¡¹ç›®å¾ˆå¯èƒ½åˆ©ç”¨ FastAPI åœ¨ server æ¨¡å—ä¸­å¯åŠ¨æœåŠ¡ï¼Œå°† tools æ¨¡å—ä¸­çš„åŠŸèƒ½ï¼ˆå¦‚ Postgres æŸ¥è¯¢æˆ–ç”Ÿæˆ ECharts å›¾è¡¨æ‰€éœ€çš„é€»è¾‘ï¼‰æš´éœ²ä¸º HTTP æ¥å£ï¼Œä¾› AgentV2 è°ƒç”¨ã€‚

AgentV2 æ¨¡å—ï¼ˆçŠ¶æ€æœºä¸ LangGraphï¼‰

AgentV2 æ˜¯æ ¸å¿ƒæ™ºèƒ½ä½“æ¨¡å—ï¼Œç”¨äº orchestrateï¼ˆç¼–æ’ï¼‰å¤šæ­¥éª¤æ¨ç†æµç¨‹ã€‚ä»é¡¹ç›®è®¾è®¡æ–‡æ¡£å¯çŸ¥ï¼Œè¯¥ç³»ç»Ÿç›®æ ‡æ˜¯â€œåŸºäºçŠ¶æ€æœºçš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿâ€ã€‚æ–‡æ¡£è¿›ä¸€æ­¥æŒ‡å‡ºâ€œç¼–æ’ï¼šLangGraphï¼ˆPythonï¼‰â€“ å¿…é¡»ç”¨ Graph ç»“æ„æ¥å¤„ç†å¾ªç¯å’ŒçŠ¶æ€â€ï¼Œè¡¨æ˜æ­¤å¤„åº”ä½¿ç”¨ LangGraph æ¡†æ¶æ¥å®šä¹‰å·¥ä½œæµã€‚LangGraph æ˜¯æ„å»ºåœ¨ LangChain ä¹‹ä¸Šçš„æœ‰çŠ¶æ€å·¥ä½œæµç¼–æ’æ¡†æ¶ï¼Œæ”¯æŒæœ‰å‘å›¾å½¢å¼å®šä¹‰èŠ‚ç‚¹ï¼ˆæ­¥éª¤ï¼‰ã€æ¡ä»¶åˆ†æ”¯ã€å¾ªç¯ã€å¹¶è¡Œæ‰§è¡Œå’Œæ£€æŸ¥ç‚¹ç­‰åŠŸèƒ½ã€‚å› æ­¤ï¼ŒAgentV2 å¾ˆå¯èƒ½é€šè¿‡ LangGraph å®šä¹‰ä¸€ä¸ªæœ‰å‘å›¾ï¼ˆGraphï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªå­ä»»åŠ¡æˆ–æ™ºèƒ½ä½“ï¼ˆå¦‚ DSL ç”Ÿæˆã€é€»è¾‘æ£€æŸ¥ã€SQL æ‰§è¡Œç­‰ï¼‰ï¼ŒçŠ¶æ€æœºé€»è¾‘åˆ™ç”±èŠ‚ç‚¹ä¹‹é—´çš„æœ‰å‘è¾¹åŠæ¡ä»¶åˆ†æ”¯æ¥æ§åˆ¶ã€‚LangGraph ä¼šè‡ªåŠ¨ç®¡ç†å„èŠ‚ç‚¹çš„è¾“å…¥è¾“å‡ºçŠ¶æ€ï¼Œç¡®ä¿ä¸åŒæ­¥éª¤ä¹‹é—´å¯ä»¥å…±äº«æ•°æ®å¹¶åœ¨å¤±è´¥æ—¶æ¢å¤ã€‚åŒæ—¶ï¼ŒLangChain å®˜æ–¹ä¹Ÿè¯´æ˜å…¶é«˜å±‚ Agent æ¶æ„å³æ„å»ºåœ¨ LangGraph ä¹‹ä¸Šï¼Œä»¥æ”¯æŒæŒä¹…åŒ–æ‰§è¡Œã€æµå¼è¾“å‡ºå’Œäººæœºäº¤äº’ã€‚ç»¼ä¸Šï¼ŒAgentV2 æ¨¡å—æ ¸å¿ƒå®ç°åº”ä¸ºä¸€ä¸ªåŸºäº LangGraph çš„æœ‰çŠ¶æ€å›¾ï¼ˆæˆ–çŠ¶æ€æœºï¼‰ï¼Œé€šè¿‡å®šä¹‰å›¾èŠ‚ç‚¹å’ŒçŠ¶æ€è½¬ç§»è§„åˆ™æ¥å®Œæˆå¤šè½®æ¨ç†ã€‚

chainsã€toolsã€baseã€server å­æ¨¡å—å…³ç³»

chains æ¨¡å—ï¼šè´Ÿè´£å®šä¹‰å¤åˆçš„æ¨ç†æµç¨‹ï¼ˆChainsï¼‰ã€‚æ¯”å¦‚ä¸€ä¸ªâ€œåˆ†æé“¾â€å¯èƒ½ä¾æ¬¡è°ƒç”¨å¤šæ­¥å·¥å…·ï¼šå…ˆç”Ÿæˆ DSLã€å†å®¡æŸ¥ DSLã€å†æ‰§è¡Œ DSLã€æœ€åç”Ÿæˆå¯è§†åŒ–ç»“æœã€‚æ¯ä¸ª Chain å¯èƒ½å¯¹åº”ä¸šåŠ¡åœºæ™¯ä¸‹çš„ä¸€ä¸ªå®Œæ•´ä»»åŠ¡åºåˆ—ï¼Œå†…éƒ¨æŒ‰é¡ºåºæˆ–æ¡ä»¶è°ƒç”¨ä¸åŒçš„å·¥å…·å‡½æ•°ã€‚LangChain æœ¬èº«å¼ºè°ƒâ€œé“¾å¼è°ƒç”¨â€ä»¥å¿«é€Ÿæ„å»º LLM åº”ç”¨ï¼Œå› æ­¤é¡¹ç›®çš„ chains å¾ˆå¯èƒ½é‡‡ç”¨ LangChain çš„é“¾æˆ–æ¨¡å—åŒ–ç®¡é“æ¥ç»„ç»‡æ­¥éª¤ï¼Œå®ç°æ¨¡å—é—´çš„é¡ºåºæˆ–å¹¶è¡Œæ‰§è¡Œã€‚

tools æ¨¡å—ï¼šæä¾›å¯è¢« Agent è°ƒç”¨çš„å…·ä½“èƒ½åŠ›ï¼ˆToolsï¼‰ã€‚å…¸å‹å·¥å…·åŒ…æ‹¬ï¼šæ•°æ®åº“æŸ¥è¯¢å·¥å…·ï¼ˆæ‰§è¡Œ PostgreSQL SQL æŸ¥è¯¢ï¼‰ã€LLM æ¥å£å·¥å…·ï¼ˆå‘å¤§å‹è¯­è¨€æ¨¡å‹å‘é€è¯·æ±‚ï¼‰ã€å›¾è¡¨ç”Ÿæˆå·¥å…·ï¼ˆç”Ÿæˆ ECharts æ‰€éœ€çš„é…ç½®ï¼‰ã€æ–‡æœ¬å¤„ç†å·¥å…·ç­‰ã€‚åœ¨ LangChain ä¸­ï¼Œå·¥å…·ï¼ˆToolï¼‰æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå¯é€šè¿‡æ³¨å†Œå¿«é€Ÿé›†æˆåˆ°æ™ºèƒ½ä½“ä¸­ã€‚é¡¹ç›®ä¸­æ¯ä¸ªå·¥å…·é€šå¸¸ç”±ä¸€ä¸ªå‡½æ•°æˆ–ç±»å®ç°ï¼Œå¹¶å¯èƒ½ç»‘å®šåˆ° LangGraph çš„å›¾èŠ‚ç‚¹ä¸Šã€‚å½“ Agent åœ¨æµç¨‹æ‰§è¡Œåˆ°æŸèŠ‚ç‚¹æ—¶ï¼Œå³è§¦å‘å¯¹åº”çš„ Tool è°ƒç”¨ã€‚

base æ¨¡å—ï¼šåŒ…å«åŸºç¡€ç±»ã€é…ç½®å’Œé€šç”¨é€»è¾‘ã€‚ä¾‹å¦‚å¯èƒ½æœ‰ BaseAgentã€BaseToolã€BaseChain ç­‰æŠ½è±¡ç±»ï¼Œä»¥åŠé…ç½®åŠ è½½ã€æ—¥å¿—ã€çŠ¶æ€ç®¡ç†ç­‰åŠŸèƒ½ã€‚è¿™äº›åŸºç±»ä¸ºå…¶ä»–æ¨¡å—æä¾›å…¬å…±æ¥å£å’Œçº¦æŸï¼Œå‡å°‘é‡å¤ä»£ç ã€‚

server æ¨¡å—ï¼šåŸºäº FastAPI æä¾›æœåŠ¡å…¥å£ã€‚å®ƒå¯èƒ½å®šä¹‰è·¯ç”±ï¼Œä¾‹å¦‚ /query æ¥å£æ¥æ”¶å‰ç«¯è¯·æ±‚ï¼Œå°†å…¶ä¼ é€’ç»™ AgentV2 æ‰§è¡Œï¼Œå¹¶è¿”å›åˆ†æç»“æœï¼›æˆ– /chart æ¥å£ç›´æ¥è¿”å› ECharts æ‰€éœ€çš„å›¾è¡¨ JSONã€‚FastAPI æ”¯æŒè‡ªåŠ¨ç”Ÿæˆäº¤äº’å¼ API æ–‡æ¡£ï¼Œå¹¶ä»¥å¼‚æ­¥æ–¹å¼å¿«é€Ÿå“åº”è¯·æ±‚ã€‚æ­¤å¤–ï¼Œserver æ¨¡å—å¯èƒ½è¿˜è´Ÿè´£å‰ç«¯é¡µé¢æˆ–å¯è§†åŒ–é¢æ¿ï¼Œå°† Agent è¾“å‡ºä¸ ECharts åº“ç»“åˆï¼Œæœ€ç»ˆå‘ˆç°ç»™ç”¨æˆ·ã€‚ECharts æ˜¯ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„å¼€æº JavaScript å¯è§†åŒ–åº“ï¼Œé€‚ç”¨äºåœ¨ Web é¡µé¢ä¸Šæ¸²æŸ“å›¾è¡¨ã€‚æœåŠ¡å™¨å¯ä»¥å°†æ•°æ®æŸ¥è¯¢ç»“æœæˆ–è®¡ç®—ç»“æœå°è£…ä¸ºç¬¦åˆ ECharts çš„ JSON æ ¼å¼ï¼Œç”±å‰ç«¯ç›´æ¥æ¸²æŸ“æˆ–é€šè¿‡ FastAPI è¿”å›ç»™å‰ç«¯ã€‚

ä¸æ•°æ®åº“å’Œ ECharts çš„é›†æˆ

é¡¹ç›®éœ€è¦è®¿é—® PostgreSQL æ•°æ®åº“å¹¶ç”Ÿæˆå¯è§†åŒ–ç»“æœã€‚è¿™ç§é›†æˆæœ‰ä¸¤ç§å¸¸è§æ–¹å¼ï¼šç›´æ¥è°ƒç”¨æˆ–é€šè¿‡ MCP åè®®è°ƒç”¨ã€‚LangChain æä¾›äº† Model Context Protocolï¼ˆMCPï¼‰é€‚é…å™¨æ¡†æ¶ï¼Œå¯å°†å¤–éƒ¨æœåŠ¡å°è£…æˆ MCP å·¥å…·ï¼Œä¾› Agent è°ƒç”¨ã€‚å¦‚æœé¡¹ç›®é‡‡ç”¨ MCPï¼Œé‚£ä¹ˆ Postgres æŸ¥è¯¢å’Œ ECharts å›¾è¡¨ç”Ÿæˆå‡½æ•°å¯ä»¥æ³¨å†Œä¸º MCP å·¥å…·æœåŠ¡å™¨ï¼ˆHTTP æˆ– stdio æœåŠ¡ï¼‰ï¼ŒAgent åœ¨å›¾çš„èŠ‚ç‚¹æ‰§è¡Œæ—¶é€šè¿‡ MCP æ¥å£è°ƒç”¨ï¼Œä¾‹å¦‚ä½¿ç”¨ langchain-mcp-adapters åº“æ‹‰å–å·¥å…·åˆ—è¡¨å¹¶è°ƒç”¨ã€‚MCP åè®®å°†æ“ä½œæ ‡å‡†åŒ–ï¼Œæ–¹ä¾¿æ™ºèƒ½ä½“ä¸æ•°æ®åº“æˆ–å…¶ä»–å¾®æœåŠ¡äº¤äº’ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨ MCPï¼Œåˆ™å¯èƒ½ç›´æ¥é€šè¿‡ Python åº“ï¼ˆå¦‚ psycopg2ã€asyncpg æˆ– SQLAlchemyï¼‰åœ¨å·¥å…·å‡½æ•°ä¸­æ‰§è¡Œ SQLï¼Œç„¶åå°†ç»“æœè½¬æ¢ä¸º ECharts èƒ½å¤Ÿæ¶ˆè´¹çš„æ ¼å¼ï¼ˆJSONï¼‰ã€‚ä¸ç®¡å“ªç§æ–¹å¼ï¼Œæœ€ç»ˆéƒ½ä¼šå°†æ•°æ®åº“æŸ¥è¯¢ç»“æœæ•´ç†ä¸ºæ•°æ®æµï¼Œåœ¨ Agent æµç¨‹ä¸­ä¼ é€’ï¼Œå¹¶ç”± server æ¨¡å—æˆ–å·¥å…·æ¨¡å—ç”Ÿæˆ ECharts é…ç½®ã€‚ECharts å®˜æ–¹è¯´æ˜â€œæä¾› 20 å¤šç§å¼€ç®±å³ç”¨çš„å›¾è¡¨ç±»å‹â€ï¼Œå¯çµæ´»ç»„åˆä½¿ç”¨ã€‚ç»“åˆ MCP æˆ– RESTful æ¥å£ï¼Œç³»ç»Ÿèƒ½å°†æ•°æ®åº“ä¸­çš„æŒ‡æ ‡è‡ªåŠ¨æ˜ å°„åˆ°å¯äº¤äº’å›¾è¡¨ã€‚

å¤šæ­¥æ¨ç†ä¸æ•°æ®æµç¨‹

è¯¥ç³»ç»Ÿçš„ Agent æ¶æ„æ”¯æŒå¤šæ­¥éª¤æ¨ç†ã€‚è®¾è®¡æ–‡æ¡£æ˜ç¡®ï¼šâ€œæˆ‘ä»¬è¦æ„å»ºçš„ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ Chainï¼Œè€Œæ˜¯ä¸€ä¸ªåŸºäºçŠ¶æ€æœºçš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿâ€ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªç”¨æˆ·é—®é¢˜ä¼šè¢«æ‹†åˆ†ä¸ºè‹¥å¹²å­ä»»åŠ¡ï¼Œç”±ä¸åŒèŠ‚ç‚¹ï¼ˆå­æ™ºèƒ½ä½“ï¼‰åä½œå®Œæˆã€‚é€šå¸¸æµç¨‹åŒ…æ‹¬ï¼šåˆ†æéœ€æ±‚ã€ç”Ÿæˆ DSLï¼ˆDomain-specific languageï¼‰â†’å®¡æŸ¥ DSL åˆæ³•æ€§â†’å°† DSL ç¼–è¯‘æˆ SQLâ†’æ‰§è¡Œ SQL è·å–ç»“æœâ†’å°†ç»“æœè½¬æ¢ä¸ºä¸šåŠ¡è§£è¯»å’Œå›¾è¡¨ã€‚æ¯ä¸€æ­¥ç”±ä¸€ä¸ªé“¾ã€ä¸€ä¸ªå›¾èŠ‚ç‚¹æˆ–ä¸€ä¸ªå·¥å…·å®Œæˆï¼Œè¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å…¥ã€‚LangGraph æ”¯æŒåœ¨å›¾ä¸­å®šä¹‰åˆ†æ”¯å’Œå¾ªç¯ï¼Œä¾‹å¦‚å®¡æŸ¥å¤±è´¥æ—¶è¿”å›é‡è¯•ï¼Œæˆ–å¤šç§æŒ‡æ ‡å¹¶è¡Œè®¡ç®—ã€‚æ•°æ®åœ¨èŠ‚ç‚¹é—´ä»¥çŠ¶æ€å½¢å¼ä¼ é€’ï¼ŒLangGraph ä¼šç®¡ç†å„çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿æ•°æ®æµé€šå’Œæ£€æŸ¥ç‚¹æ¢å¤ã€‚è¿™ç§å¤šæ™ºèƒ½ä½“ã€æœ‰çŠ¶æ€çš„æµç¨‹è®©ç³»ç»Ÿèƒ½å¤Ÿé€æ­¥ä¿®æ­£é”™è¯¯ã€æ ¡éªŒç»“æœã€åŠ¨æ€è·å–ä¸Šä¸‹æ–‡ï¼Œç¬¦åˆâ€œè‡ªåŠ¨çº é”™ã€å¤šå±‚éªŒè¯â€çš„è®¾è®¡æ€è·¯ã€‚é€šè¿‡æ¨¡å—åŒ–åˆ†å·¥ï¼Œä¾‹å¦‚â€œGenerator Agent è´Ÿè´£ç”Ÿæˆ DSLâ€ã€â€œReviewer Agent è´Ÿè´£è¯­ä¹‰æ£€æŸ¥â€ã€â€œCompiler å°† DSL è½¬æ¢ä¸º SQLâ€ç­‰ï¼Œç³»ç»Ÿå„éƒ¨åˆ†èŒè´£æ¸…æ™°ã€å¯ç»´æŠ¤ã€‚

ä¾èµ–åº“åŠç‰ˆæœ¬

é¡¹ç›®æ ¸å¿ƒä¾èµ–åŒ…æ‹¬ï¼šLangChain å’Œ LangGraphï¼ˆç”¨äº Agent å’Œå·¥ä½œæµç¼–æ’ï¼‰ã€FastAPIï¼ˆWeb æ¡†æ¶ï¼‰ã€langchain-mcp-adaptersï¼ˆå¯é€‰ï¼Œç”¨äº MCP åè®®è°ƒç”¨ï¼‰ã€LLM æ¨¡å‹ SDKï¼ˆå¦‚ OpenAI æˆ– Anthropic å®¢æˆ·ç«¯åº“ï¼‰ã€SQL é©±åŠ¨ï¼ˆå¦‚ psycopg2ã€SQLAlchemyã€asyncpg ç­‰ç”¨äº PostgreSQL è®¿é—®ï¼‰ã€å‰ç«¯å¯è§†åŒ–åº“ EChartsã€‚ä¾‹å¦‚ï¼ŒLangChain å®˜æ–¹å¿«é€Ÿå¼€å§‹ç¤ºä¾‹ä¸­ä½¿ç”¨äº† pip install -U langchain "langchain[anthropic]" å¹¶è°ƒç”¨æŒ‡å®šçš„ Claude æ¨¡å‹ï¼›è¿™è¡¨æ˜é¡¹ç›®å¯èƒ½æ”¯æŒ Anthropicã€OpenAI ç­‰å¤šç§ LLMã€‚LangChain æ–‡æ¡£æŒ‡å‡ºï¼ŒLangChain ä»£ç†å†…ç½®å¯¹å¤šç§æ¨¡å‹å’Œå·¥å…·çš„é›†æˆï¼Œè€Œ LangGraph åˆ™æ˜¯å…¶åº•å±‚ç¼–æ’å¼•æ“ã€‚å› æ­¤åº”ç¡®ä¿ LangChain ä¸ LangGraph ç‰ˆæœ¬å…¼å®¹ï¼ˆé€šå¸¸å®‰è£…æœ€æ–°ç¨³å®šç‰ˆï¼‰ã€‚FastAPI æœ€æ–°ç‰ˆå¯åœ¨ Python 3.8+ ç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œå…¶æ€§èƒ½ä¼˜å¼‚ã€‚æ­¤å¤–ï¼Œå¦‚æœä½¿ç”¨ langchain-mcp-adaptersï¼Œåˆ™éœ€ä¸ FastAPI ç­‰ç»„ä»¶é…åˆä½¿ç”¨ã€‚ECharts å‰ç«¯å¯ä» Apache å®˜æ–¹è·å–æœ€æ–°ç‰ˆåº“ï¼ˆä¾‹å¦‚é€šè¿‡ CDN è½½å…¥ï¼‰ï¼Œæ— éœ€åœ¨ Python ç«¯å®‰è£…ã€‚

è¿ç§»æ³¨æ„äº‹é¡¹ä¸é£é™©

åœ¨è¿ç§»åˆ°æ–°çš„ SOTA æ•°æ®åˆ†æç³»ç»Ÿæ—¶ï¼Œåº”æ³¨æ„ä»¥ä¸‹é£é™©å’Œè¦ç‚¹ï¼š

ä¾èµ–å…¼å®¹æ€§ï¼šLangChain/LangGraph ç”Ÿæ€æ›´æ–°è¾ƒå¿«ï¼Œå¿…é¡»ç¡®ä¿é¡¹ç›®ä¸­çš„ç‰ˆæœ¬ä¸æ–‡æ¡£ç¤ºä¾‹å…¼å®¹ã€‚ä¸åŒç‰ˆæœ¬çš„ LangChain å…¶ Agents API æˆ–è®¸æœ‰å·®å¼‚ã€‚ä½¿ç”¨ MCP æ—¶ï¼Œè¦æ ¸å¯¹ langchain-mcp-adapters å’Œ FastAPI çš„ç‰ˆæœ¬å…¼å®¹æ€§ã€‚å»ºè®®é”å®šä¾èµ–ç‰ˆæœ¬å¹¶è¿›è¡Œæµ‹è¯•ã€‚

å¤šæ™ºèƒ½ä½“å¤æ‚åº¦ï¼šçŠ¶æ€æœºå’Œå¤šAgentæ¶æ„å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ã€‚ä¾‹å¦‚å›¾ä¸­åˆ†æ”¯ã€å¾ªç¯çš„æ¡ä»¶éœ€è¦ä¸¥æ ¼è®¾è®¡ï¼Œé¿å…æ­»å¾ªç¯æˆ–çŠ¶æ€æ³„æ¼ã€‚æ–‡æ¡£å¼ºè°ƒäº†â€œè‡ªåŠ¨çº é”™â€å’Œå¤šå±‚éªŒè¯æœºåˆ¶ï¼Œè¯´æ˜ç³»ç»Ÿéœ€è¦å¤§é‡è¾¹ç¼˜æƒ…å†µå¤„ç†ã€‚è¿ç§»æ—¶åº”å……åˆ†æµ‹è¯•å„ç§å¤±è´¥åœºæ™¯ï¼Œç¡®ä¿å„èŠ‚ç‚¹çš„é”™è¯¯èƒ½è¢«æ•è·å¹¶çº æ­£ã€‚

æ•°æ®åº“å®‰å…¨ä¸æ€§èƒ½ï¼šç›´æ¥æš´éœ²æŸ¥è¯¢æ¥å£æ—¶é¡»æ³¨æ„ SQL æ³¨å…¥å’Œè®¿é—®æ§åˆ¶ã€‚å‚è€ƒæ–‡æ¡£å»ºè®®ä½¿ç”¨è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰ç­‰ã€‚è¿ç§»æ—¶å¯èƒ½è¦é‡æ„æŸ¥è¯¢å·¥å…·ï¼Œç¡®ä¿ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ã€åˆé€‚çš„äº‹åŠ¡éš”ç¦»ã€‚å¯¹ ECharts å¯è§†åŒ–è€Œè¨€ï¼Œç»˜åˆ¶å¤§è§„æ¨¡æ•°æ®æ—¶è¦æ³¨æ„å‰ç«¯æ€§èƒ½ï¼ˆå¯é‡‡ç”¨æ•°æ®ä¸‹é‡‡æ ·ã€æœåŠ¡ç«¯åˆ†é¡µç­‰ï¼‰ã€‚

LLM è°ƒç”¨æˆæœ¬ä¸å‡†ç¡®æ€§ï¼šä¸åŒæ¨¡å‹è¾“å‡ºç¨³å®šæ€§å·®å¼‚å¤§ã€‚é¡¹ç›®æ–‡æ¡£å³å¼ºè°ƒé™ä½ LLM è‡ªç”±ç”Ÿæˆ SQL çš„é£é™©ï¼Œé€šè¿‡ DSL æ–¹å¼æé«˜å‡†ç¡®ç‡ã€‚è¿ç§»æ—¶åº”é€‰æ‹©åˆé€‚çš„æ¨¡å‹ï¼ˆå¦‚ç”¨Claudeç­‰æ ¡éªŒæ¨¡å‹ï¼‰ï¼Œå¹¶æ§åˆ¶è°ƒç”¨é¢‘ç‡ä»¥èŠ‚çœæˆæœ¬ã€‚å¯¹ç»“æœè¿˜åº”æä¾›æ—¥å¿—å’Œè·Ÿè¸ªï¼ˆå¯ç»“åˆ LangSmith å¹³å°ï¼‰ä»¥å®¡è®¡å†³ç­–è¿‡ç¨‹ã€‚

æ•´ä½“ç›‘æ§ä¸æ—¥å¿—ï¼šFastAPI æœåŠ¡éœ€è€ƒè™‘å¹¶å‘ä¸èµ„æºä½¿ç”¨ï¼Œéƒ¨ç½²æ—¶å¯ä½¿ç”¨ Uvicorn/Gunicorn ç­‰é«˜æ€§èƒ½æœåŠ¡å™¨ã€‚å¯èƒ½è¿˜éœ€å®ç°è¯·æ±‚è¿½è¸ªï¼ˆè§‚å¯Ÿæ¯æ¬¡ Agent æ‰§è¡Œè·¯å¾„ï¼‰å’Œé‡è¯•æœºåˆ¶ã€‚åœ¨å›¾å½¢ç•Œé¢é›†æˆæ–¹é¢ï¼Œè¦æ³¨æ„å‰åç«¯æ¥å£ç»Ÿä¸€ï¼ˆä¾‹å¦‚ FastAPI è¿”å› ECharts JSONï¼Œå‰ç«¯è¦æ­£ç¡®è§£æï¼‰ï¼Œå¹¶åšå¥½ç‰ˆæœ¬å‡çº§æ—¶çš„å…¼å®¹æ€§æµ‹è¯•ã€‚

ç»¼ä¸Šï¼Œç†è§£å„æ¨¡å—çš„èŒè´£ä¸ä¾èµ–ã€ç¡®ä¿ç¼–æ’é€»è¾‘æ­£ç¡®æ˜¯å…³é”®ã€‚é€šè¿‡å‚è€ƒé¡¹ç›®æ–‡æ¡£å’Œä¸Šè¿°å¼€æºèµ„æºï¼Œå¯ä»¥ä¸º DeepAgents è¿ç§»æä¾›å…¨é¢çš„ä¸Šä¸‹æ–‡ä¾æ®