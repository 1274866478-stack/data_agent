# AIåŠ©æ‰‹ç¼–é€ æ•°æ®é—®é¢˜è¯Šæ–­

## é—®é¢˜æè¿°
AIåŠ©æ‰‹åœ¨å›ç­”"åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·"æ—¶ï¼Œè¿”å›äº†ç¼–é€ çš„è‹±æ–‡æ•°æ®ï¼ˆjohn_doe, jane_smithç­‰ï¼‰ï¼Œè€Œä¸æ˜¯ä»Excelæ–‡ä»¶ä¸­è¯»å–çš„çœŸå®ä¸­æ–‡æ•°æ®ï¼ˆå¼ ä¼Ÿã€æå¨œç­‰ï¼‰ã€‚

## å¯èƒ½çš„åŸå› åˆ†æ

### 1. å·¥å…·è°ƒç”¨æ ¹æœ¬æ²¡æœ‰å‘ç”Ÿ
**ç—‡çŠ¶**ï¼šAIç›´æ¥ç”Ÿæˆäº†ç­”æ¡ˆï¼Œæ²¡æœ‰è°ƒç”¨ä»»ä½•å·¥å…·
**æ£€æŸ¥æ–¹æ³•**ï¼š
- æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `tool_calls` è®°å½•
- æ£€æŸ¥ `all_messages` ä¸­æ˜¯å¦æœ‰ `ToolMessage` ç±»å‹çš„æ¶ˆæ¯
- æŸ¥çœ‹æ˜¯å¦æœ‰ `inspect_file` æˆ– `analyze_dataframe` çš„è°ƒç”¨è®°å½•

**å¯èƒ½åŸå› **ï¼š
- LLMè®¤ä¸ºä¸éœ€è¦è°ƒç”¨å·¥å…·å°±èƒ½å›ç­”é—®é¢˜
- ç³»ç»Ÿæç¤ºè¯ä¸å¤Ÿå¼ºåˆ¶ï¼ŒLLMé€‰æ‹©è·³è¿‡å·¥å…·è°ƒç”¨
- å·¥å…·ç»‘å®šå¤±è´¥ï¼ŒLLMçœ‹ä¸åˆ°å¯ç”¨å·¥å…·

### 2. å·¥å…·è°ƒç”¨å¤±è´¥ä½†é”™è¯¯è¢«å¿½ç•¥
**ç—‡çŠ¶**ï¼šå·¥å…·è¢«è°ƒç”¨äº†ï¼Œä½†è¿”å›äº†é”™è¯¯ï¼ŒLLMä»ç„¶ç”Ÿæˆäº†ç­”æ¡ˆ
**æ£€æŸ¥æ–¹æ³•**ï¼š
- æŸ¥çœ‹ `ToolMessage` çš„å†…å®¹ï¼Œæ˜¯å¦åŒ…å«é”™è¯¯ä¿¡æ¯
- æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆ`/app/data/ecommerce_test_data.xlsx`ï¼‰
- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥æ˜¯å¦æœ‰æƒé™è¯»å–æ–‡ä»¶

**å¯èƒ½åŸå› **ï¼š
- æ–‡ä»¶è·¯å¾„é”™è¯¯ï¼ˆå®¹å™¨å†…è·¯å¾„ vs æœ¬åœ°è·¯å¾„ï¼‰
- æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®
- Excelæ–‡ä»¶æ ¼å¼é—®é¢˜ï¼ˆéœ€è¦openpyxlå¼•æ“ï¼‰
- å·¥ä½œè¡¨åç§°é”™è¯¯ï¼ˆåº”è¯¥ä½¿ç”¨"ç”¨æˆ·è¡¨"è€Œä¸æ˜¯"users"ï¼‰

### 3. å·¥å…·è¿”å›äº†ç©ºæ•°æ®
**ç—‡çŠ¶**ï¼šå·¥å…·æˆåŠŸæ‰§è¡Œï¼Œä½†è¿”å›ç©ºç»“æœï¼ŒLLMä»ç„¶ç”Ÿæˆäº†ç­”æ¡ˆ
**æ£€æŸ¥æ–¹æ³•**ï¼š
- æŸ¥çœ‹ `ToolMessage` çš„å†…å®¹ï¼Œæ˜¯å¦ä¸ºç©ºæˆ–åªåŒ…å«è¡¨å¤´
- æ£€æŸ¥Excelæ–‡ä»¶æ˜¯å¦çœŸçš„åŒ…å«æ•°æ®
- æ£€æŸ¥å·¥ä½œè¡¨åç§°æ˜¯å¦æ­£ç¡®

**å¯èƒ½åŸå› **ï¼š
- Excelæ–‡ä»¶çš„å·¥ä½œè¡¨åç§°ä¸åŒ¹é…ï¼ˆ"ç”¨æˆ·è¡¨" vs "users"ï¼‰
- å·¥ä½œè¡¨æ˜¯ç©ºçš„
- æ•°æ®è¯»å–å¤±è´¥ä½†æ²¡æœ‰æŠ¥é”™

### 4. LLMçœ‹åˆ°äº†å·¥å…·ç»“æœä½†é€‰æ‹©å¿½ç•¥
**ç—‡çŠ¶**ï¼šå·¥å…·è¿”å›äº†æ­£ç¡®çš„æ•°æ®ï¼Œä½†LLMä»ç„¶ç”Ÿæˆäº†ç¼–é€ çš„æ•°æ®
**æ£€æŸ¥æ–¹æ³•**ï¼š
- æŸ¥çœ‹ `ToolMessage` çš„å†…å®¹ï¼Œç¡®è®¤æ˜¯å¦åŒ…å«çœŸå®æ•°æ®
- æ£€æŸ¥ç³»ç»Ÿæç¤ºè¯æ˜¯å¦è¶³å¤Ÿå¼ºåˆ¶
- æ£€æŸ¥LLMçš„temperatureè®¾ç½®ï¼ˆåº”è¯¥ä¸º0ï¼‰

**å¯èƒ½åŸå› **ï¼š
- ç³»ç»Ÿæç¤ºè¯ä¸å¤Ÿå¼ºåˆ¶
- LLMçš„temperatureå¤ªé«˜ï¼Œå¯¼è‡´éšæœºæ€§
- å·¥å…·è¿”å›çš„æ•°æ®æ ¼å¼LLMæ— æ³•ç†è§£

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šå¯ç”¨è¯¦ç»†æ—¥å¿—
åœ¨ `backend/src/app/api/v1/endpoints/query.py` ä¸­ï¼Œå°† `verbose=False` æ”¹ä¸º `verbose=True`ï¼š

```python
agent_response = await run_agent_query(
    question=request.query,
    thread_id=thread_id,
    database_url=database_url,
    verbose=True,  # æ”¹ä¸º True
    enable_echarts=True
)
```

### æ­¥éª¤2ï¼šæ£€æŸ¥å·¥å…·è°ƒç”¨å†å²
åœ¨ `backend/src/app/services/agent/agent_service.py` çš„ `run_agent` å‡½æ•°ä¸­ï¼Œæ·»åŠ æ—¥å¿—è®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨ï¼š

```python
# åœ¨æ”¶é›†æ¶ˆæ¯åï¼Œè®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨
tool_calls_log = []
for msg in all_messages:
    if isinstance(msg, AIMessage) and msg.tool_calls:
        for tc in msg.tool_calls:
            tool_calls_log.append({
                "tool": tc.get("name"),
                "args": tc.get("args")
            })
    elif isinstance(msg, ToolMessage):
        tool_calls_log.append({
            "tool_result": getattr(msg, 'name', 'unknown'),
            "content_preview": str(msg.content)[:200]
        })

logger.info(f"å·¥å…·è°ƒç”¨å†å²: {tool_calls_log}")
```

### æ­¥éª¤3ï¼šéªŒè¯æ–‡ä»¶è·¯å¾„å’Œå†…å®¹
åœ¨ `backend/src/app/services/agent/tools.py` çš„ `analyze_dataframe_func` ä¸­ï¼Œæ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—ï¼š

```python
# åœ¨è¯»å–æ–‡ä»¶å‰
logger.info(f"å°è¯•è¯»å–æ–‡ä»¶: {container_file_path}")
logger.info(f"æ–‡ä»¶æ˜¯å¦å­˜åœ¨: {os.path.exists(container_file_path)}")
if os.path.exists(container_file_path):
    logger.info(f"æ–‡ä»¶å¤§å°: {os.path.getsize(container_file_path)} bytes")

# åœ¨è¯»å–Excelå
if container_file_path.endswith('.xlsx'):
    excel_file = pd.ExcelFile(container_file_path, engine='openpyxl')
    logger.info(f"Excelå·¥ä½œè¡¨åˆ—è¡¨: {excel_file.sheet_names}")
    logger.info(f"è¯»å–çš„å·¥ä½œè¡¨: {sheet_name or 'ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨'}")
    logger.info(f"æ•°æ®è¡Œæ•°: {len(df)}, åˆ—æ•°: {len(df.columns)}")
    logger.info(f"åˆ—å: {list(df.columns)}")
    logger.info(f"å‰5è¡Œæ•°æ®é¢„è§ˆ: {df.head().to_string()}")
```

### æ­¥éª¤4ï¼šå¼ºåˆ¶è¦æ±‚å·¥å…·è°ƒç”¨
åœ¨ç³»ç»Ÿæç¤ºè¯ä¸­æ·»åŠ æ›´ä¸¥æ ¼çš„è§„åˆ™ï¼š

```python
## ğŸš¨ ç»å¯¹ç¦æ­¢é¡¹ï¼ˆè¿åå°†å¯¼è‡´å›ç­”æ— æ•ˆï¼‰ï¼š
- **åœ¨æ²¡æœ‰è°ƒç”¨å·¥å…·çš„æƒ…å†µä¸‹ç›´æ¥ç”Ÿæˆç­”æ¡ˆ**
- **åœ¨å·¥å…·è¿”å›é”™è¯¯æˆ–ç©ºæ•°æ®æ—¶ä»ç„¶ç”Ÿæˆç­”æ¡ˆ**
- **ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä»£æ›¿å·¥å…·è¿”å›çš„çœŸå®æ•°æ®**
```

## é¢„æœŸä¿®å¤

ä¿®å¤åï¼ŒAIåŠ©æ‰‹åº”è¯¥ï¼š
1. é¦–å…ˆè°ƒç”¨ `inspect_file` æŸ¥çœ‹Excelæ–‡ä»¶çš„å·¥ä½œè¡¨åˆ—è¡¨
2. ç¡®è®¤"ç”¨æˆ·è¡¨"å·¥ä½œè¡¨å­˜åœ¨
3. è°ƒç”¨ `analyze_dataframe` è¯»å–"ç”¨æˆ·è¡¨"å·¥ä½œè¡¨çš„æ•°æ®
4. ä½¿ç”¨å·¥å…·è¿”å›çš„çœŸå®æ•°æ®ï¼ˆä¸­æ–‡ç”¨æˆ·åï¼‰ç”Ÿæˆç­”æ¡ˆ
5. å¦‚æœå·¥å…·è¿”å›é”™è¯¯æˆ–ç©ºæ•°æ®ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·"æ— æ³•è¯»å–æ•°æ®"


