# 电商测试数据库使用指南

## 📦 数据库概述

**数据库名称**: `ecommerce_test_db`  
**业务场景**: 在线零售商城  
**数据规模**: 10个用户，15个商品，14个订单，23个订单明细，10条评价

---

## 🗂️ 数据库结构

### 1. 用户表 (users)
存储用户基本信息和会员等级

**字段说明：**
- `id` - 用户ID（主键）
- `username` - 用户名
- `email` - 邮箱
- `phone` - 手机号
- `gender` - 性别
- `birth_date` - 出生日期
- `registration_date` - 注册时间
- `vip_level` - 会员等级（0-3）
- `total_spent` - 累计消费金额
- `is_active` - 是否活跃

**数据特点：**
- 10个用户，包含不同VIP等级
- 消费金额从2340元到18900元不等

### 2. 收货地址表 (addresses)
存储用户的收货地址信息

**字段说明：**
- `id` - 地址ID（主键）
- `user_id` - 用户ID（外键）
- `province` - 省份
- `city` - 城市
- `district` - 区县
- `detail_address` - 详细地址
- `is_default` - 是否默认地址

**数据特点：**
- 覆盖全国主要城市（北上广深杭等）

### 3. 商品类别表 (categories)
商品分类层级结构

**字段说明：**
- `id` - 类别ID（主键）
- `name` - 类别名称
- `parent_id` - 父类别ID（支持多级分类）
- `description` - 描述
- `sort_order` - 排序

**数据特点：**
- 2级分类结构
- 主要类别：电子产品、服装鞋包、家居生活、图书音像、食品饮料

### 4. 商品表 (products)
商品详细信息

**字段说明：**
- `id` - 商品ID（主键）
- `name` - 商品名称
- `category_id` - 类别ID（外键）
- `sku` - 商品编码
- `price` - 当前价格
- `original_price` - 原价
- `stock` - 库存数量
- `sales_count` - 销量
- `rating` - 评分（1-5）
- `review_count` - 评价数量
- `brand` - 品牌
- `description` - 商品描述
- `is_on_sale` - 是否在售
- `created_at` - 创建时间

**数据特点：**
- 15个商品，涵盖手机、电脑、配件、服装等
- 价格从199元到14999元
- 包含Apple、华为、小米、索尼等知名品牌

### 5. 订单表 (orders)
订单主表

**字段说明：**
- `id` - 订单ID（主键）
- `order_no` - 订单号
- `user_id` - 用户ID（外键）
- `address_id` - 收货地址ID（外键）
- `total_amount` - 商品总金额
- `discount_amount` - 优惠金额
- `shipping_fee` - 运费
- `final_amount` - 实付金额
- `status` - 订单状态
- `payment_method` - 支付方式
- `payment_time` - 支付时间
- `shipping_time` - 发货时间
- `completed_time` - 完成时间
- `created_at` - 创建时间
- `remark` - 备注

**订单状态：**
- `pending` - 待付款（1个）
- `paid` - 已付款（2个）
- `shipped` - 已发货（2个）
- `completed` - 已完成（8个）
- `cancelled` - 已取消（1个）

**数据特点：**
- 14个订单，时间跨度2024年1月-4月
- 支付方式：支付宝、微信支付
- 订单金额从1251元到18100元

### 6. 订单明细表 (order_items)
订单商品明细

**字段说明：**
- `id` - 明细ID（主键）
- `order_id` - 订单ID（外键）
- `product_id` - 商品ID（外键）
- `product_name` - 商品名称（冗余存储）
- `sku` - 商品编码
- `price` - 购买时价格
- `quantity` - 购买数量
- `subtotal` - 小计金额

**数据特点：**
- 23条订单明细
- 部分订单包含多个商品

### 7. 商品评价表 (reviews)
用户对商品的评价

**字段说明：**
- `id` - 评价ID（主键）
- `order_id` - 订单ID（外键）
- `product_id` - 商品ID（外键）
- `user_id` - 用户ID（外键）
- `rating` - 评分（1-5星）
- `content` - 评价内容
- `images` - 评价图片（数组）
- `is_anonymous` - 是否匿名
- `helpful_count` - 有用数
- `created_at` - 评价时间

**数据特点：**
- 10条真实评价
- 评分以4-5星为主
- 包含详细的评价内容

---

## 🚀 初始化步骤

### 步骤1: 创建数据库

```bash
# 连接到PostgreSQL
psql -h localhost -U dev -d postgres

# 创建数据库
CREATE DATABASE ecommerce_test_db;

# 退出
\q
```

### 步骤2: 初始化数据

```bash
# 执行初始化脚本
psql -h localhost -U dev -d ecommerce_test_db -f scripts/init-ecommerce-test-db.sql
```

### 步骤3: 验证数据

```bash
# 连接到数据库
psql -h localhost -U dev -d ecommerce_test_db

# 查看表列表
\dt

# 查看数据统计
SELECT 
    (SELECT COUNT(*) FROM users) as user_count,
    (SELECT COUNT(*) FROM products) as product_count,
    (SELECT COUNT(*) FROM orders) as order_count,
    (SELECT COUNT(*) FROM reviews) as review_count;
```

---

## 📊 示例查询

### 1. 用户分析

```sql
-- 查询VIP用户数量
SELECT vip_level, COUNT(*) as user_count, AVG(total_spent) as avg_spent
FROM users
GROUP BY vip_level
ORDER BY vip_level DESC;

-- 查询消费最高的前5名用户
SELECT username, email, total_spent, vip_level
FROM users
ORDER BY total_spent DESC
LIMIT 5;
```

### 2. 商品分析

```sql
-- 查询销量最高的前10个商品
SELECT name, brand, price, sales_count, rating
FROM products
ORDER BY sales_count DESC
LIMIT 10;

-- 查询各品牌的商品数量和平均价格
SELECT brand, COUNT(*) as product_count, AVG(price) as avg_price
FROM products
GROUP BY brand
ORDER BY product_count DESC;

-- 查询库存不足100的商品
SELECT name, brand, stock, sales_count
FROM products
WHERE stock < 100
ORDER BY stock ASC;
```

### 3. 订单分析

```sql
-- 查询2024年每月的订单统计
SELECT * FROM sales_summary;

-- 查询各状态订单数量
SELECT status, COUNT(*) as order_count, SUM(final_amount) as total_amount
FROM orders
GROUP BY status
ORDER BY order_count DESC;

-- 查询平均订单金额
SELECT AVG(final_amount) as avg_order_value
FROM orders
WHERE status != 'cancelled';
```

### 4. 销售分析

```sql
-- 查询最畅销的商品（按销售额）
SELECT p.name, p.brand, SUM(oi.subtotal) as total_sales, SUM(oi.quantity) as total_quantity
FROM order_items oi
JOIN products p ON oi.product_id = p.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status != 'cancelled'
GROUP BY p.id, p.name, p.brand
ORDER BY total_sales DESC
LIMIT 10;

-- 查询各类别的销售情况
SELECT c.name as category, COUNT(DISTINCT oi.order_id) as order_count, SUM(oi.subtotal) as total_sales
FROM order_items oi
JOIN products p ON oi.product_id = p.id
JOIN categories c ON p.category_id = c.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status != 'cancelled'
GROUP BY c.id, c.name
ORDER BY total_sales DESC;
```

### 5. 用户行为分析

```sql
-- 查询用户购买频次
SELECT u.username, COUNT(DISTINCT o.id) as order_count, SUM(o.final_amount) as total_spent
FROM users u
LEFT JOIN orders o ON u.id = o.user_id AND o.status != 'cancelled'
GROUP BY u.id, u.username
ORDER BY order_count DESC;

-- 查询复购率最高的商品
SELECT p.name, COUNT(DISTINCT oi.order_id) as purchase_count
FROM order_items oi
JOIN products p ON oi.product_id = p.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status != 'cancelled'
GROUP BY p.id, p.name
HAVING COUNT(DISTINCT oi.order_id) > 1
ORDER BY purchase_count DESC;
```

---

## 🔗 添加到Data Agent

### 连接信息

```
名称: 电商测试数据库
类型: PostgreSQL
连接字符串: postgresql://dev:dev123@localhost:5432/ecommerce_test_db
描述: 在线零售商城测试数据，包含用户、商品、订单、评价等完整业务数据
```

### 通过API添加

```bash
curl -X POST http://localhost:8004/api/v1/data-sources \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "电商测试数据库",
    "db_type": "postgresql",
    "connection_string": "postgresql://dev:dev123@localhost:5432/ecommerce_test_db",
    "description": "在线零售商城测试数据，包含用户、商品、订单、评价等完整业务数据"
  }'
```

---

## 💡 AI测试问题示例

添加数据源后，可以尝试以下问题：

1. **用户分析**
   - "有多少VIP用户？"
   - "消费最高的用户是谁？"
   - "平均每个用户消费多少钱？"

2. **商品分析**
   - "销量最高的商品是什么？"
   - "哪个品牌的商品最多？"
   - "库存不足100的商品有哪些？"

3. **订单分析**
   - "2024年3月有多少订单？"
   - "平均订单金额是多少？"
   - "有多少订单已完成？"

4. **销售分析**
   - "销售额最高的商品是什么？"
   - "哪个类别的商品卖得最好？"
   - "iPhone的总销售额是多少？"

5. **评价分析**
   - "评分最高的商品是什么？"
   - "有多少5星好评？"
   - "哪个商品的评价最多？"

---

**创建日期**: 2025-11-30  
**版本**: V1.0

